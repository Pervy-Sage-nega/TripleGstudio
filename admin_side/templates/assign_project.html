{% extends 'admin-nav-footer-template/base.html' %}
{% load static %}

{% block title %}Assign Site Manager to Project | Triple G BuildHub{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="{% static 'css/admincss/nav.css' %}">
    <link rel="stylesheet" href="{% static 'css/sitecss/dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'css/admincss/header.css' %}">
    <link rel="stylesheet" href="{% static 'css/admincss/adminhome.css' %}">
    <link rel="stylesheet" href="{% static 'css/admincss/blog-management.css' %}">
    <link rel="stylesheet" href="{% static 'css/sitecss/global-modal.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .assignment-form {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid #e1e5e9;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            max-width: 1400px;
            margin: 0 auto;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: #ffffff;
            max-height: 200px;
            overflow-y: auto;
        }
        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        select.form-control {
            max-height: none;
            overflow: visible;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            
            font-weight: 500;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background: #3c6e71;
            color: white;
            margin-bottom: 10px;
            border-color: #3c6e71;
        }
        .btn-primary:hover {
            background: #2a5154;
        }
        .btn-secondary {
            height: 36px;
            margin-bottom: 10px;
            padding: 0 12px;
            border: 1px solid #dddddd;
            background-color: white;
            color: var(--dark-gray);
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .btn-secondary:hover {
            background: #f8f9fa;
            border-color: #adb5bd;
        }
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }
        .assignments-list {
            margin-top: 30px;
        }
        .assignment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        .assignment-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .assignment-info {
            flex: 1;
        }
        .assignment-actions {
            display: flex;
            gap: 10px;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container">
    {% csrf_token %}
    <div class="page-header">
        <div class="page-title">
            <i class="fas fa-user-cog"></i>
            <h1>Assign Site Manager to Project</h1>
        </div>
    </div>

    <div class="grid">
        <!-- Assignment Form -->
        <div class="assignment-form">
            <h3>Assign Site Managers to Project</h3>
            
            <div class="form-group">
                <label for="multi_project">Select Project</label>
                <select id="multi_project" class="form-control">
                    <option value="">Select Project</option>
                    {% for project in projects %}
                        <option value="{{ project.id }}">{{ project.name }} - {{ project.client_name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div id="assignments-container" style="display: none;">
                <h4>Add Assignments</h4>
                <div id="assignment-rows"></div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" id="add-assignment" class="btn btn-secondary">
                        <i class="fas fa-plus"></i> Add Another
                    </button>
                    <button type="button" id="save-assignments" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Assignments
                    </button>
                    <a href="{% url 'admin_side:admin_user_list' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back
                    </a>
                </div>
            </div>
        </div>

        <!-- Current Assignments -->
        <div class="assignment-form">
            <h3>Current Assignments</h3>
            {% for assignment in current_assignments %}
                <div class="assignment-item">
                    <div class="assignment-info">
                        <strong>{{ assignment.project.name }}</strong><br>
                        <small>{{ assignment.user.get_full_name }} as {{ assignment.get_role_display }}</small>
                        <small style="color: #666;">Assigned on {{ assignment.assigned_date|date:"M d, Y" }}</small>
                    </div>
                    <div class="assignment-actions">
                        <a href="{% url 'admin_side:remove_assignment' assignment.id %}" class="btn btn-secondary btn-sm">
                            <i class="fas fa-times"></i> Remove
                        </a>
                    </div>
                </div>
            {% empty %}
                <p>No current assignments.</p>
            {% endfor %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const multiProject = document.getElementById('multi_project');
    const assignmentsContainer = document.getElementById('assignments-container');
    const assignmentRows = document.getElementById('assignment-rows');
    const addAssignmentBtn = document.getElementById('add-assignment');
    const saveAssignmentsBtn = document.getElementById('save-assignments');
    
    const siteManagers = {{ site_managers_json|safe }};
    const roleChoices = {{ role_choices_json|safe }};
    
    let assignmentCount = 0;
    
    multiProject.addEventListener('change', function() {
        if (this.value) {
            assignmentsContainer.style.display = 'block';
            addAssignmentRow();
        } else {
            assignmentsContainer.style.display = 'none';
            assignmentRows.innerHTML = '';
            assignmentCount = 0;
        }
    });
    
    addAssignmentBtn.addEventListener('click', addAssignmentRow);
    
    function addAssignmentRow() {
        const row = document.createElement('div');
        row.className = 'assignment-row';
        row.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px; align-items: center;';
        
        let userOptions = '<option value="">Select User</option>';
        siteManagers.forEach(manager => {
            userOptions += `<option value="${manager.id}">${manager.name} (${manager.username})</option>`;
        });
        
        let roleOptions = '<option value="">Select Role</option>';
        roleChoices.forEach(role => {
            roleOptions += `<option value="${role.value}">${role.display}</option>`;
        });
        
        row.innerHTML = `
            <select class="form-control user-select" style="flex: 1;">
                ${userOptions}
            </select>
            <select class="form-control role-select" style="flex: 1;">
                ${roleOptions}
            </select>
            <button type="button" class="btn btn-secondary btn-sm remove-row">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        assignmentRows.appendChild(row);
        assignmentCount++;
        
        // Add remove functionality
        row.querySelector('.remove-row').addEventListener('click', function() {
            row.remove();
            assignmentCount--;
        });
    }
    
    saveAssignmentsBtn.addEventListener('click', function() {
        const projectId = multiProject.value;
        if (!projectId) {
            window.globalModal.error('Selection Required', 'Please select a project before saving assignments.');
            return;
        }
        
        const assignments = [];
        const rows = assignmentRows.querySelectorAll('.assignment-row');
        
        rows.forEach(row => {
            const userId = row.querySelector('.user-select').value;
            const role = row.querySelector('.role-select').value;
            
            if (userId && role) {
                assignments.push({ user_id: userId, role: role });
            }
        });
        
        if (assignments.length === 0) {
            window.globalModal.error('Assignment Required', 'Please add at least one assignment before saving.');
            return;
        }
        
        // Send AJAX request
        fetch('{% url "admin_side:assign_project" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                project_id: projectId,
                assignments: assignments
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.globalModal.success('Assignment Successful', data.message, () => {
                    location.reload();
                });
            } else {
                window.globalModal.error('Assignment Failed', data.message);
            }
        })
        .catch(error => {
            window.globalModal.error('Network Error', 'Failed to save assignments: ' + error.message);
        });
    });
});
</script>
<script src="{% static 'js/sitejs/global-modal.js' %}"></script>
{% endblock %}