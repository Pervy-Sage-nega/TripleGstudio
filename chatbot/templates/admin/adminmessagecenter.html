{% extends 'admin-nav-footer-template/base.html' %}
{% load static %}
{% block title %}Admin Project Portfolio Management | Triple G BuildHub{% endblock %}
{% block extra_head %}

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Message Center | Triple G BuildHub</title>
    <link rel="stylesheet" href="{% static 'css/sitecss/dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'css/sitecss/history.css' %}">
    <link rel="stylesheet" href="{% static 'css/sitecss/chatbot.css' %}">
    <link rel="stylesheet" href="{% static 'css/admincss/adminmessagecenter.css' %}">
    <link rel="stylesheet" href="{% static 'css/admincss/header.css' %}">
    <link rel="stylesheet" href="{% static 'css/admincss/nav.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    {% endblock %}
    {% block content %}
    
    
<body>
   

    <div class="container">
        <div class="page-header">
            <div class="page-title"> <i class="fas fa-comments"></i>
                <h1>Admin Message Center</h1> <span class="notification-badge">{{ new_count }}</span>
            </div>
            <div class="export-options"> <button class="btn btn-primary" id="refreshBtn"><i class="fas fa-sync-alt"></i>
                    Refresh</button> <button class="btn btn-primary" id="exportPdfBtn"><i class="fas fa-file-pdf"></i>
                    PDF</button> <button class="btn btn-primary" id="exportCsvBtn"><i class="fas fa-file-csv"></i>
                    CSV</button> <button class="btn btn-secondary" id="printBtn"><i class="fas fa-print"></i>
                    Print</button> </div>
        </div>

        <!-- Status Tracker Section -->
        <div class="status-tracker">
            <div class="status-card">
                <div class="status-icon status-new-icon">
                    <i class="fas fa-envelope"></i>
                </div>
                <div class="status-info">
                    <h3>{{ new_count }}</h3>
                    <p>New</p>
                </div>
            </div>
            <div class="status-card">
                <div class="status-icon status-read-icon">
                    <i class="fas fa-envelope-open"></i>
                </div>
                <div class="status-info">
                    <h3>{{ read_count }}</h3>
                    <p>Read</p>
                </div>
            </div>
            <div class="status-card">
                <div class="status-icon status-reviewed-icon">
                    <i class="fas fa-clipboard-check"></i>
                </div>
                <div class="status-info">
                    <h3>{{ reviewed_count }}</h3>
                    <p>Reviewed</p>
                </div>
            </div>
            <div class="status-card">
                <div class="status-icon status-archived-icon">
                    <i class="fas fa-archive"></i>
                </div>
                <div class="status-info">
                    <h3>{{ archived_count }}</h3>
                    <p>Archived</p>
                </div>
            </div>
        </div>

        <!-- View Toggle and Tab Navigation -->
        <div class="view-controls">
            <div class="tabs">
                <button class="tab-btn active" data-tab="all">All Messages</button>
                <button class="tab-btn" data-tab="new">New</button>
                <button class="tab-btn" data-tab="read">Read</button>
                <button class="tab-btn" data-tab="reviewed">Reviewed</button>
                <button class="tab-btn" data-tab="archived">Archived</button>
            </div>

            <div class="view-toggle">
                <button id="timelineViewBtn" class="view-btn active" title="Timeline View">
                    <i class="fas fa-stream"></i>
                </button>
                <button id="tableViewBtn" class="view-btn" title="Table View">
                    <i class="fas fa-table"></i>
                </button>
            </div>
        </div>

        <!-- Filter and Search Section -->
        <div class="filter-container">
            <div class="filter-header">
                <div class="filter-title">
                    <i class="fas fa-filter"></i>
                    <span>Filter Messages</span>
                </div>

                <button class="filter-toggle" id="filterToggle">
                    <span>Show Filters</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
            </div>

            <div class="search-box">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" placeholder="Search by name, email, project, or keyword...">
            </div>

            <div class="filter-options" id="filterOptions" style="display: none;">
                <div class="filter-group">
                    <label for="filter-project">Project Name</label>
                    <select id="filter-project">
                        <option value="">All Projects</option>
                        <option value="Central Business District Tower">Central Business District Tower</option>
                        <option value="Highway Bridge Expansion">Highway Bridge Expansion</option>
                        <option value="Residential Complex Phase 2">Residential Complex Phase 2</option>
                        <option value="Waterfront Development">Waterfront Development</option>
                        <option value="Tech Innovation Hub">Tech Innovation Hub</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="filter-inquiry">Inquiry Type</label>
                    <select id="filter-inquiry">
                        <option value="">All Types</option>
                        <option value="Appointment">Appointment Request</option>
                        <option value="Milestone">Milestone Question</option>
                        <option value="General">General Question</option>
                        <option value="Complaint">Complaint</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="filter-status">Status</label>
                    <select id="filter-status">
                        <option value="">All Status</option>
                        <option value="New">New</option>
                        <option value="Read">Read</option>
                        <option value="Reviewed">Reviewed</option>
                        <option value="Archived">Archived</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="filter-priority">Priority</label>
                    <select id="filter-priority">
                        <option value="">All Priorities</option>
                        <option value="High">High</option>
                        <option value="Medium">Medium</option>
                        <option value="Low">Low</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="filter-date-from">Date From</label>
                    <input type="date" id="filter-date-from">
                </div>

                <div class="filter-group">
                    <label for="filter-date-to">Date To</label>
                    <input type="date" id="filter-date-to">
                </div>

                <div class="filter-buttons">
                    <button class="btn btn-secondary" id="resetFilters">
                        <i class="fas fa-undo"></i>
                        Reset
                    </button>
                    <button class="btn btn-primary" id="applyFilters">
                        <i class="fas fa-check"></i>
                        Apply Filters
                    </button>
                </div>
            </div>
        </div>

        <!-- Timeline View -->
        <div class="timeline-view" id="timelineView">
            <div class="timeline-line"></div>

            {% for message in contact_messages %}
            <!-- Timeline Item {{ message.id }} -->
            <div class="timeline-item" data-status="{{ message.status }}">
                <div class="timeline-header" data-id="{{ message.id }}">
                    <div class="timeline-date">
                        <i class="fas fa-user-circle"></i>
                        <div>
                            <h3>{{ message.name }}</h3>
                            <span>{{ message.created_at|date:"M d, Y • g:i A" }}</span>
                            <span class="log-status status-{{ message.status }}" style="color: white;">{{ message.get_status_display }}</span>
                        </div>
                    </div>
                    <div class="timeline-actions">
                        {% if message.status == 'new' %}
                        <button class="action-btn mark-read" title="Mark as Read">
                            <i class="fas fa-check"></i>
                        </button>
                        {% elif message.status == 'read' %}
                        <button class="action-btn mark-reviewed" title="Mark as Reviewed">
                            <i class="fas fa-clipboard-check"></i>
                        </button>
                        <button class="action-btn mark-unread" title="Mark as Unread">
                            <i class="fas fa-undo"></i>
                        </button>
                        {% elif message.status == 'reviewed' %}
                        <button class="action-btn mark-unread" title="Mark as Unread">
                            <i class="fas fa-undo"></i>
                        </button>
                        {% elif message.status == 'archived' %}
                        <button class="action-btn unarchive" title="Unarchive Message">
                            <i class="fas fa-box-open"></i>
                        </button>
                        {% endif %}
                        
                        {% if message.status != 'archived' %}
                        <button class="action-btn archive" title="Archive Message">
                            <i class="fas fa-archive"></i>
                        </button>
                        {% endif %}
                        
                        <button class="action-btn delete" title="Delete Message">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                        <button class="action-btn expand" title="Expand/Collapse">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </div>
                </div>

                <div class="timeline-content" id="content{{ message.id }}">
                    <div class="timeline-client-info">
                        <div class="info-group">
                            <div class="info-label">Subject</div>
                            <div class="info-value">{{ message.get_subject_display }}</div>
                        </div>
                        <div class="info-group">
                            <div class="info-label">Email</div>
                            <div class="info-value">{{ message.email }}</div>
                        </div>
                        {% if message.phone %}
                        <div class="info-group">
                            <div class="info-label">Phone</div>
                            <div class="info-value">{{ message.phone }}</div>
                        </div>
                        {% endif %}
                        <div class="info-group">
                            <div class="info-label">Inquiry Type</div>
                            <div class="info-value">
                                <span class="inquiry-type inquiry-{{ message.subject }}">{{ message.get_subject_display }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="activities-section">
                        <div class="section-title">
                            <i class="fas fa-comment-alt"></i>
                            <span>Client Message</span>
                        </div>
                        <div class="message-content">
                            {{ message.message|linebreaks }}
                        </div>
                    </div>

                    <div class="admin-notes-section">
                        <div class="section-title">
                            <i class="fas fa-sticky-note"></i>
                            <span>Admin Notes</span>
                        </div>
                        <textarea class="admin-notes-textarea" data-message-id="{{ message.id }}"
                            placeholder="Add internal notes here (only visible to admins)...">{{ message.admin_notes }}</textarea>
                        <button class="btn btn-primary save-notes-btn" data-message-id="{{ message.id }}">Save Notes</button>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="timeline-item">
                <div class="timeline-content">
                    <p style="text-align: center; color: #ccc; padding: 40px;">No contact messages found.</p>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Table View -->
        <div class="table-view" id="tableView" style="display: none;">
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Date & Time</th>
                            <th>Client</th>
                            <th>Project</th>
                            <th>Inquiry Type</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for message in contact_messages %}
                        <tr data-status="{{ message.status }}">
                            <td>{{ message.created_at|date:"M d, Y • g:i A" }}</td>
                            <td>
                                <div class="client-name">{{ message.name }}</div>
                                <div class="client-email">{{ message.email }}</div>
                            </td>
                            <td>{{ message.get_subject_display }}</td>
                            <td>
                                <div class="table-inquiry-type">
                                    <span class="inquiry-type inquiry-{{ message.subject }}">{{ message.get_subject_display }}</span>
                                </div>
                            </td>
                            <td>
                                <span class="log-status status-{{ message.status }}" style="color: white;">{{ message.get_status_display }}</span>
                            </td>
                            <td>
                                <div class="table-actions">
                                    <button class="action-btn view" title="View Details" data-id="{{ message.id }}">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    {% if message.status == 'new' %}
                                    <button class="action-btn mark-read" title="Mark as Read">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    {% elif message.status == 'read' %}
                                    <button class="action-btn mark-reviewed" title="Mark as Reviewed">
                                        <i class="fas fa-clipboard-check"></i>
                                    </button>
                                    <button class="action-btn mark-unread" title="Mark as Unread">
                                        <i class="fas fa-undo"></i>
                                    </button>
                                    {% elif message.status == 'reviewed' %}
                                    <button class="action-btn mark-unread" title="Mark as Unread">
                                        <i class="fas fa-undo"></i>
                                    </button>
                                    {% elif message.status == 'archived' %}
                                    <button class="action-btn unarchive" title="Unarchive Message">
                                        <i class="fas fa-box-open"></i>
                                    </button>
                                    {% endif %}
                                    
                                    {% if message.status != 'archived' %}
                                    <button class="action-btn archive" title="Archive Message">
                                        <i class="fas fa-archive"></i>
                                    </button>
                                    {% endif %}
                                    
                                    <button class="action-btn delete" title="Delete Message">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" style="text-align: center; color: #ccc; padding: 40px;">No contact messages found.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Analytics Section -->
        <div class="analytics-section">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-chart-bar"></i>
                    Message Analytics
                </div>
                <button class="section-toggle" id="analyticsToggle">
                    <i class="fas fa-chevron-down"></i>
                </button>
            </div>

            <div class="analytics-content" id="analyticsContent" style="display: none;">
                <div class="analytics-grid">
                    <div class="chart-container">
                        <h3>Inquiry Type Distribution</h3>
                        <canvas id="inquiryTypeChart"></canvas>
                    </div>

                    <div class="chart-container">
                        <h3>Message Volume by Project</h3>
                        <canvas id="projectChart"></canvas>
                    </div>

                    <div class="chart-container">
                        <h3>Daily Message Volume</h3>
                        <canvas id="dailyVolumeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pagination -->
        <div class="pagination">
            <button class="page-btn disabled">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button class="page-btn active">1</button>
            <button class="page-btn">2</button>
            <button class="page-btn">3</button>
            <span class="pagination-ellipsis">...</span>
            <button class="page-btn">10</button>
            <button class="page-btn">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>

    <!-- Message View Modal -->
    <div class="modal" id="messageModal">
        <div class="modal-content message-modal">
            <div class="modal-header">
                <h3>Message Details</h3>
                <button class="modal-close" id="closeMessageModal">&times;</button>
            </div>
            <div class="modal-body" id="messageModalContent">
                <!-- Content will be dynamically inserted here -->
            </div>
            <div class="modal-footer">
                <div class="modal-actions">
                    <button class="btn btn-secondary" id="closeModalBtn">Close</button>
                    <button class="btn btn-primary" id="updateStatusBtn">Update Status</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal" id="confirmationModal">
        <div class="modal-content confirmation-modal">
            <div class="modal-header">
                <h3 id="confirmationTitle">Confirmation</h3>
                <button class="modal-close" id="closeConfirmationModal">&times;</button>
            </div>
            <div class="modal-body">
                <p id="confirmationMessage">Are you sure you want to perform this action?</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelConfirmationBtn">Cancel</button>
                <button class="btn btn-primary" id="confirmActionBtn">Confirm</button>
            </div>
        </div>
    </div>

    {% endblock %}
{% block extra_scripts %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{% static 'js/adminjs/mobile-btn.js' %}"></script>
    <script src="{% static 'js/adminjs/adminmessagecenter.js' %}"></script>
    {% endblock %}
</body>

</html>