+
{% extends "site_diary/layout_format.html" %}
{% load static %}

{% block head %}
    <title>Blog Drafts - Triple G BuildHub</title>
    <link rel="stylesheet" href="{% static 'css/sitecss/global-header.css' %}">
    <link rel="stylesheet" href="{% static 'css/sitecss/global-footer.css' %}">
     <link rel="stylesheet" href="{% static 'css/sitecss/dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'css/sitecss/drafts.css' %}">
    <link rel="stylesheet" href="{% static 'css/sitecss/blog-ui-fixes.css' %}">
   
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block body %}
    <!-- Global Header Placeholder -->
    <div id="header-placeholder"></div>

    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <div class="page-title">
                <i class="fas fa-file-alt"></i>
                <h1>Blog Drafts</h1>
            </div>
            <div class="user-info">
                <div class="user-greeting">
                    <div class="user-name">{{ user.get_full_name|default:user.username }}</div>
                    <div class="user-role">Site Manager</div>
                </div>
                <div class="user-avatar">
                    {% if user.sitemanagerprofile.profile_pic %}
                        <img src="{{ user.sitemanagerprofile.profile_pic.url }}" alt="{{ user.get_full_name|default:user.username }}">
                    {% else %}
                        {{ user.get_full_name|default:user.username|slice:":2"|upper }}
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Dashboard Stats -->
        <div class="stats-container">
            <!-- Stat Card 1 -->
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-pencil-alt"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="drafts-count">{{ draft_posts }}</div>
                    <div class="stat-label">Saved Drafts</div>
                </div>
            </div>

            <!-- Stat Card 2 -->
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-file"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="recent-count">{{ total_posts }}</div>
                    <div class="stat-label">Total Posts</div>
                </div>
            </div>

            <!-- Stat Card 3 -->
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-paper-plane"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="submitted-count">{{ published_posts }}</div>
                    <div class="stat-label">Published</div>
                </div>
            </div>
        </div>

        <!-- Blog Drafts Section -->
        <div class="drafts-section">
            <div class="section-header">
                <h2>My Blog Drafts</h2>
                <div class="view-toggle">
                    <button class="view-btn active" data-view="card">
                        <i class="fas fa-th"></i> Card View
                    </button>
                    <button class="view-btn" data-view="table">
                        <i class="fas fa-list"></i> Table View
                    </button>
                </div>
            </div>
            
            <div class="filter-search-controls">
                <div class="filter-group">
                    <select class="filter-dropdown" id="status-filter">
                        <option value="">All Status</option>
                        <option value="published">Published</option>
                        <option value="archived">Archived</option>
                        <option value="draft">Draft</option>
                        <option value="rejected">Rejected</option>
                    </select>
                </div>
                <div class="filter-group">
                    <select class="filter-dropdown" id="category-filter">
                        <option value="">All Categories</option>
                        {% for category in all_categories %}
                        <option value="{{ category.slug }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="search-group">
                    <i class="fas fa-search"></i>
                    <input type="text" class="search-input" id="search-input" placeholder="Search drafts...">
                </div>
                
                <div class="action-buttons">
                    <a href="{% url 'blog:recently_deleted' %}" class="btn btn-secondary">
                        <i class="fas fa-trash-restore"></i>
                        Recently Deleted
                    </a>
                    <a href="{% url 'blog:createblog' %}" class="new-post-btn btn btn-primary">
                        <i class="fas fa-plus"></i>
                        New Blog Post
                    </a>
                </div>
            </div>
        



        <!-- Card View (Default) -->
        <div class="drafts-container card-view" id="drafts-card-view">
            {% if blog_posts %}
                {% for blog in blog_posts %}
                <div class="draft-card">
                    <!-- Featured Image Thumbnail -->
                    <div class="draft-thumbnail">
                        {% if blog.featured_image %}
                            <img src="{{ blog.featured_image.url }}" alt="{{ blog.featured_image_alt|default:blog.title }}" class="thumbnail-image">
                        {% else %}
                            <div class="thumbnail-placeholder">
                                <i class="fas fa-image"></i>
                                <span>No Image</span>
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Content Area -->
                    <div class="draft-content">
                        <div class="draft-header">
                            <div class="draft-category">{{ blog.category.name|default:"Uncategorized" }}</div>
                            <div class="draft-date">
                                <i class="far fa-calendar-alt"></i> <span class="date-value">{{ blog.created_date|date:"Y-m-d" }}</span>
                            </div>
                        </div>
                        <div class="draft-body">
                            <h3 class="draft-title">{{ blog.title }}</h3>
                            <p class="draft-excerpt">{{ blog.excerpt|default:blog.content|truncatewords:15|striptags }}</p>
                            <div class="status-section">
                                <span class="status-badge status-{{ blog.status }}">{{ blog.get_status_display }}</span>
                                {% if blog.rejection_reason %}
                                <span class="rejection-badge">
                                    <i class="fas fa-exclamation-triangle"></i> Rejected
                                </span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="draft-tags">
                            {% for tag in blog.tags.all|slice:":3" %}
                            <span class="draft-tag">{{ tag.name }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="draft-actions">
                        <a href="#" class="action-btn preview-btn" title="Preview" data-blog-id="{{ blog.id }}">
                            <i class="fas fa-eye"></i>
                        </a>
                        {% if blog.rejection_reason %}
                        <button class="action-btn comments-btn" title="View Admin Comments" onclick="showRejectionComments({{ blog.id }})">
                            <i class="fas fa-comment-alt"></i>
                        </button>
                        {% endif %}
                        <a href="{% url 'blog:createblog' %}?edit={{ blog.id }}" class="action-btn edit-btn" title="Edit">
                            <i class="fas fa-edit"></i>
                        </a>
                        <button class="action-btn delete-btn" title="Delete" onclick="confirmDelete({{ blog.id }}, '{{ blog.title|escapejs }}')">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
                {% endfor %}
            {% else %}
            <div class="no-results">
                <i class="fas fa-inbox"></i>
                <h3>No Blog Posts Found</h3>
                <p>You haven't created any blog posts yet. Start creating a new blog post to get started.</p>
                <a href="{% url 'blog:createblog' %}" class="btn btn-primary">
                    <i class="fas fa-plus"></i>
                    Create New Blog Post
                </a>
            </div>
            {% endif %}
        </div>

        <!-- Table View (Hidden by default) -->
        <div class="drafts-container table-view" id="drafts-table-view" style="display: none;">
            <div class="table-responsive">
                <table id="drafts-table">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Category</th>
                            <th>Last Modified</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="drafts-table-body">
                        {% for blog in blog_posts %}
                        <tr>
                            <td>{{ blog.title }}</td>
                            <td>{{ blog.category.name|default:"Uncategorized" }}</td>
                            <td>{{ blog.updated_date|date:"Y-m-d H:i" }}</td>
                            <td><span class="status-badge status-{{ blog.status }}">{{ blog.get_status_display }}</span></td>
                            <td>
                                <a href="#" class="action-btn view" title="Preview" data-blog-id="{{ blog.id }}"><i class="fas fa-eye"></i></a>
                                <a href="{% url 'blog:createblog' %}?edit={{ blog.id }}" class="action-btn edit" title="Edit"><i class="fas fa-edit"></i></a>
                                <button class="action-btn delete" title="Delete" onclick="confirmDelete({{ blog.id }}, '{{ blog.title|escapejs }}')"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 40px;">No blog posts found</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pagination -->
        <div class="pagination" id="pagination">
            <!-- Pagination will be populated via JavaScript if needed -->
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="previewModal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <div class="preview-header">
                <h2 id="preview-title">Draft Title</h2>
                <div class="preview-meta">
                    <span class="preview-category"><i class="fas fa-folder"></i> <span id="preview-category">Category</span></span>
                    <span class="preview-author"><i class="fas fa-user"></i> Architect</span>
                    <span class="preview-time"><i class="far fa-clock"></i> <span id="preview-reading-time">5</span> min read</span>
                </div>
            </div>
            <div class="preview-image-container">
                <img id="preview-image" src="{% static '/images/image1.jpg' %}" alt="Featured image preview">
            </div>
            <div id="preview-content" class="preview-content">
                <!-- Draft content will be inserted here -->
            </div>
            <div class="preview-tags" id="preview-tags">
                <!-- Tags will be inserted here -->
            </div>
            <div class="preview-actions">
                <button class="btn btn-secondary" id="preview-close-btn">Close</button>
                <button class="btn btn-primary" id="preview-edit-btn">
                    <i class="fas fa-edit"></i> Edit Draft
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content confirmation-modal">
            <span class="close-modal">&times;</span>
            <div class="modal-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h2 class="modal-title">Delete Draft</h2>
            <p class="modal-message">Are you sure you want to delete this draft? This action cannot be undone.</p>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="delete-cancel-btn">Cancel</button>
                <button class="btn btn-danger" id="delete-confirm-btn">Delete</button>
            </div>
        </div>
    </div>

    <!-- Submit Confirmation Modal -->
    <div id="submitModal" class="modal">
        <div class="modal-content confirmation-modal">
            <span class="close-modal">&times;</span>
            <div class="modal-icon">
                <i class="fas fa-paper-plane"></i>
            </div>
            <h2 class="modal-title">Submit Draft</h2>
            <p class="modal-message">Are you sure you want to submit this draft for admin approval?</p>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="submit-cancel-btn">Cancel</button>
                <button class="btn btn-primary" id="submit-confirm-btn">Submit</button>
            </div>
        </div>
    </div>

    <!-- Success Notification Modal -->
    <div id="notificationModal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <div class="modal-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <h2 class="modal-title">Success!</h2>
            <p class="modal-message">Your draft has been submitted for admin approval.</p>
            <div class="modal-actions">
                <button class="btn btn-primary modal-confirm">OK</button>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="previewModal" class="modal">
        <div class="modal-content preview-modal-content" style="max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 class="modal-title">Blog Post Preview</h2>
                <button class="close-modal" id="preview-close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="preview-header">
                    <h1 id="preview-title">Blog Title</h1>
                    <div class="preview-meta">
                        <span class="preview-category" id="preview-category">Category</span>
                        <span class="preview-reading-time"><i class="fas fa-clock"></i> <span id="preview-reading-time">5</span> min read</span>
                        <span class="preview-date"><i class="fas fa-calendar"></i> <span id="preview-date">Date</span></span>
                        <span class="preview-status" id="preview-status">Draft</span>
                    </div>
                </div>
                
                <div class="preview-image-container">
                    <img id="preview-image" src="" alt="Featured Image" style="display: none;">
                </div>
                
                <div class="preview-content" id="preview-content">
                    <p>Blog content will appear here...</p>
                </div>
                
                <div class="preview-tags" id="preview-tags">
                    <!-- Tags will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="preview-close-btn">Close</button>
                <button class="btn btn-primary" id="preview-edit-btn">Edit Post</button>
            </div>
        </div>
    </div>

    <!-- Global Footer Placeholder -->
    <div id="footer-placeholder"></div>

    <!-- Additional CSS for Preview Modal -->
    <style>
        /* Modal Base Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
        }
        
        .modal.active {
            display: flex !important;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .modal-header {
            padding: 20px 20px 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: between;
            align-items: center;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            padding: 10px 20px 20px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-modal:hover {
            color: #333;
        }
        
        .preview-modal-content {
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        a.btn.btn-secondary {
    height: 40px;
}
        .preview-header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2rem;
        }
        
        .preview-meta {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        .preview-category {
            background: #3498db;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
        }
        
        .preview-content {
            line-height: 1.6;
            margin: 20px 0;
            color: #34495e;
        }
        
        .preview-tags {
            margin-top: 20px;
        }
        
        .preview-tag {
            display: inline-block;
            background: var(--primary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-right: 8px;
            margin-bottom: 8px;
        }
        
        .preview-image-container {
            margin: 20px 0;
            text-align: center;
        }
        
        .preview-image-container img {
            width: 100%;
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            max-height: 300px;
            object-fit: cover;
        }
        
        .preview-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .preview-meta span {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
            color: #666;
        }
        
        .preview-status {
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 500;
        }
        
        .preview-text {
            line-height: 1.6;
            color: #333;
        }
        
        .preview-text p {
            margin-bottom: 15px;
        }
        
        /* Custom scrollbar for modal content */
        .modal-body::-webkit-scrollbar,
        .preview-content::-webkit-scrollbar {
            width: 8px;
        }
        
        .modal-body::-webkit-scrollbar-track,
        .preview-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .modal-body::-webkit-scrollbar-thumb,
        .preview-content::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        .modal-body::-webkit-scrollbar-thumb:hover,
        .preview-content::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Rejection badge styling */
        .status-section {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .rejection-badge {
            background: #dc3545;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .comments-btn {
            background: #17a2b8 !important;
        }

        .comments-btn:hover {
            background: #138496 !important;
        }

        /* Rejection comments modal styling */
        .rejection-details {
            padding: 20px 0;
        }

        .rejection-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid #dc3545;
        }

        .rejection-info p {
            margin: 5px 0;
            color: #495057;
        }

        .rejection-reason h4 {
            color: #dc3545;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .reason-text {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            line-height: 1.6;
            color: #495057;
            white-space: pre-wrap;
        }
        
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
    </style>

    <!-- Rejection Comments Modal -->
    <div id="rejectionCommentsModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5);">
        <div style="display: flex; justify-content: center; align-items: center; width: 100%; height: 100%;">
        <div class="modal-content" style="background: white; border-radius: 8px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; margin: 0; position: relative;">
            <div class="modal-header" style="padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                <h2 style="margin: 0; font-size: 18px; color: #333;">Admin Rejection Comments</h2>
                <span class="close" onclick="closeRejectionCommentsModal()" style="cursor: pointer; font-size: 24px; font-weight: bold; color: #999;">&times;</span>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <div id="rejectionCommentsContent">
                    <!-- Content will be loaded here -->
                </div>
            </div>
        </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- <script src="{% static 'js/sitejs/global-navs-footerjs/mobile-btn.js' %}"></script> -->
    <script src="{% static 'js/sitejs/drafts.js' %}"></script>
    
    <script>
        // Blog posts data for JavaScript access
        const blogPostsData = {
            {% for blog in blog_posts %}
            {{ blog.id }}: {
                'rejection_reason': `{{ blog.rejection_reason|default:""|escapejs }}`,
                'rejected_by': `{% if blog.rejected_by %}{{ blog.rejected_by.get_full_name|default:blog.rejected_by.username|escapejs }}{% endif %}`,
                'rejected_at': `{{ blog.rejected_at|date:"M d, Y g:i A"|default:""|escapejs }}`
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        };

        // Show rejection comments modal
        function showRejectionComments(blogId) {
            const blogData = blogPostsData[blogId];
            if (!blogData || !blogData.rejection_reason) {
                alert('No rejection comments found for this post.');
                return;
            }

            const content = `
                <div class="rejection-details">
                    <div class="rejection-info">
                        <p><strong>Rejected by:</strong> ${blogData.rejected_by}</p>
                        <p><strong>Rejected on:</strong> ${blogData.rejected_at}</p>
                    </div>
                    <div class="rejection-reason">
                        <h4>Reason for Rejection:</h4>
                        <div class="reason-text">${blogData.rejection_reason}</div>
                    </div>
                </div>
            `;

            document.getElementById('rejectionCommentsContent').innerHTML = content;
            document.getElementById('rejectionCommentsModal').style.display = 'flex';
        }

        // Close rejection comments modal
        function closeRejectionCommentsModal() {
            document.getElementById('rejectionCommentsModal').style.display = 'none';
        }

        // Confirm delete function
        function confirmDelete(blogId, blogTitle) {
            if (confirm('Are you sure you want to delete "' + blogTitle + '"? It will be moved to recently deleted.')) {
                window.location.href = '{% url "blog:delete_blog" 0 %}'.replace('0', blogId);
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('rejectionCommentsModal');
            if (event.target === modal) {
                closeRejectionCommentsModal();
            }
        }
    </script>
</body>
</html>
{% endblock %}