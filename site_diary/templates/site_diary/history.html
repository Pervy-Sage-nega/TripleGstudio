{% extends "site_diary/layout_format.html" %}
{% load static %}

{% block head %}
    <title>Site Diary - History</title>
    <link rel="stylesheet" href="{% static 'css/sitecss/history.css' %}">
    <link rel="stylesheet" href="{% static 'css/sitecss/createblog.css' %}">
    <link rel="stylesheet" href="{% static 'css/sitecss/global-footer.css' %}">
    <link rel="stylesheet" href="{% static 'css/sitecss/dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'css/admincss/nav.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block body %}
    <!-- Navigation Bar -->
   
    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <div class="page-title">
                <i class="fas fa-history"></i>
                <h1>Site Diary History</h1>
            </div>

            <div class="view-toggle">
                <button id="timelineViewBtn" class="view-btn active" title="Timeline View">
                    <i class="fas fa-stream"></i>
                </button>
                <button id="tableViewBtn" class="view-btn" title="Table View">
                    <i class="fas fa-table"></i>
                </button>
            </div>
        </div>

            <!-- Page Header already exists in your code -->
            
            <!-- Filter and Search Section -->
            <div class="filter-container">
                <div class="filter-header">
                    <div class="filter-title">
                        <i class="fas fa-filter"></i>
                        <span>Filter Entries</span>
                    </div>
                    <button class="filter-toggle" id="filterToggle">
                        <span>Show Filters</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
                
                <div class="search-box">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" placeholder="Search entries...">
                </div>
                
                <div class="filter-options" id="filterOptions" style="display: none;">
                    <div class="filter-group">
                        <label for="filter-project">Project Name</label>
                        <select id="filter-project">
                            <option value="">All Projects</option>
                            <option value="Central Business District Tower">Central Business District Tower</option>
                            <option value="Highway Bridge Expansion">Highway Bridge Expansion</option>
                            <option value="Residential Complex Phase 2">Residential Complex Phase 2</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="filter-date-from">Date From</label>
                        <input type="date" id="filter-date-from">
                    </div>
                    
                    <div class="filter-group">
                        <label for="filter-date-to">Date To</label>
                        <input type="date" id="filter-date-to">
                    </div>
                    
                    <div class="filter-group">
                        <label for="filter-weather">Weather Condition</label>
                        <select id="filter-weather">
                            <option value="">All Weather</option>
                            <option value="Sunny">Sunny</option>
                            <option value="Cloudy">Cloudy</option>
                            <option value="Rainy">Rainy</option>
                            <option value="Windy">Windy</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="filter-personnel">Personnel</label>
                        <select id="filter-personnel">
                            <option value="">All Personnel</option>
                            <option value="John Smith">John Smith</option>
                            <option value="Sarah Johnson">Sarah Johnson</option>
                            <option value="Michael Brown">Michael Brown</option>
                        </select>
                    </div>
                    
                    <div class="filter-buttons">
                        <button class="btn btn-secondary" id="resetFilters">
                            <i class="fas fa-undo"></i>
                            Reset
                        </button>
                        <button class="btn btn-primary" id="applyFilters">
                            <i class="fas fa-check"></i>
                            Apply Filters
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Timeline View -->
            <div class="timeline-view" id="timelineView">
                <div class="timeline-line"></div>
                
                {% for entry in page_obj %}
                <!-- Timeline Item {{ forloop.counter }} -->
                <div class="timeline-item">
                    <div class="timeline-header" data-id="{{ entry.id }}">
                        <div class="timeline-date">
                            <i class="fas fa-calendar-alt"></i>
                            <div>
                                <h3>{{ entry.project.name }}</h3>
                                <span>{{ entry.entry_date|date:"M d, Y" }}</span>
                            </div>
                        </div>
                        <div class="timeline-actions">
                            <button class="action-btn download" title="Download PDF">
                                <i class="fas fa-file-pdf"></i>
                            </button>
                            <button class="action-btn revision" title="Add Revision">
                                <i class="fas fa-history"></i>
                            </button>
                            <button class="action-btn expand" title="Expand/Collapse">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="timeline-content" id="content{{ entry.id }}">
                        <div class="project-info">
                            <div class="info-group">
                                <div class="info-label">Location</div>
                                <div class="info-value">{{ entry.project.location|default:"Not specified" }}</div>
                            </div>
                            <div class="info-group">
                                <div class="info-label">Created By</div>
                                <div class="info-value">{{ entry.created_by.get_full_name|default:entry.created_by.username }}</div>
                            </div>
                            <div class="info-group">
                                <div class="info-label">Progress</div>
                                <div class="info-value">{{ entry.progress_percentage }}%</div>
                            </div>
                            <div class="info-group">
                                <div class="info-label">Status</div>
                                <div class="info-value">{% if entry.approved %}Approved{% else %}Pending{% endif %}</div>
                            </div>
                        </div>
                        
                        {% if entry.weather_condition %}
                        <div class="weather-info">
                            <i class="fas fa-{% if entry.weather_condition == 'sunny' %}sun{% elif entry.weather_condition == 'rainy' %}cloud-rain{% elif entry.weather_condition == 'cloudy' %}cloud{% else %}cloud{% endif %} weather-icon"></i>
                            <div class="weather-details">
                                {% if entry.temperature_high %}
                                <div class="weather-detail">
                                    <i class="fas fa-thermometer-half"></i>
                                    <span>{{ entry.temperature_high }}°C</span>
                                </div>
                                {% endif %}
                                <div class="weather-detail">
                                    <i class="fas fa-cloud"></i>
                                    <span>{{ entry.get_weather_condition_display }}</span>
                                </div>
                                {% if entry.wind_speed %}
                                <div class="weather-detail">
                                    <i class="fas fa-wind"></i>
                                    <span>{{ entry.wind_speed }} km/h</span>
                                </div>
                                {% endif %}
                                {% if entry.humidity %}
                                <div class="weather-detail">
                                    <i class="fas fa-tint"></i>
                                    <span>Humidity: {{ entry.humidity }}%</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="activities-section">
                            <div class="section-title">
                                <i class="fas fa-tasks"></i>
                                <span>Work Performed</span>
                            </div>
                            <p class="activity-text">
                                {{ entry.work_description|default:"No work description provided." }}
                            </p>
                        </div>
                        
                        {% if entry.quality_issues or entry.safety_incidents %}
                        <div class="activities-section">
                            <div class="section-title">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span>Issues & Safety</span>
                            </div>
                            {% if entry.quality_issues %}
                            <p class="activity-text">
                                <strong>Quality Issues:</strong> {{ entry.quality_issues }}
                            </p>
                            {% endif %}
                            {% if entry.safety_incidents %}
                            <p class="activity-text">
                                <strong>Safety Incidents:</strong> {{ entry.safety_incidents }}
                            </p>
                            {% endif %}
                        </div>
                        {% endif %}
                        
                        {% if entry.photos_taken %}
                        <div class="activities-section">
                            <div class="section-title">
                                <i class="fas fa-camera"></i>
                                <span>Site Photos</span>
                            </div>
                            <div class="photo-gallery">
                                <div class="gallery-item">
                                    <img src="{% static 'images/image3.jpg' %}" alt="Site Photo">
                                    <span class="photo-count">Photos Available</span>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% empty %}
                <div class="timeline-item">
                    <div class="no-entries">
                        <i class="fas fa-calendar-times"></i>
                        <h3>No Diary Entries Found</h3>
                        <p>No diary entries match your current filters.</p>
                    </div>
                </div>
                {% endfor %}
                

            </div>
            
            <!-- Table View -->
            <div class="table-view" id="tableView">
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Project</th>
                                <th>Location</th>
                                <th>Weather</th>
                                <th>Created By</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for entry in page_obj %}
                            <tr>
                                <td>{{ entry.entry_date|date:"M d, Y" }}</td>
                                <td class="table-project-name">{{ entry.project.name }}</td>
                                <td>{{ entry.project.location|default:"Not specified" }}</td>
                                <td>
                                    {% if entry.weather_condition %}
                                    <div class="table-weather">
                                        <i class="fas fa-{% if entry.weather_condition == 'sunny' %}sun{% elif entry.weather_condition == 'rainy' %}cloud-rain{% elif entry.weather_condition == 'cloudy' %}cloud{% else %}cloud{% endif %}"></i>
                                        <span>{{ entry.get_weather_condition_display }}{% if entry.temperature_high %}, {{ entry.temperature_high }}°C{% endif %}</span>
                                    </div>
                                    {% else %}
                                    <span class="text-muted">No data</span>
                                    {% endif %}
                                </td>
                                <td>{{ entry.created_by.get_full_name|default:entry.created_by.username }}</td>
                                <td>
                                    <div class="table-actions">
                                        <button class="action-btn download" title="Download PDF">
                                            <i class="fas fa-file-pdf"></i>
                                        </button>
                                        <button class="action-btn view" title="View Details" onclick="viewEntry({{ entry.id }})">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="action-btn revision" title="Add Revision">
                                            <i class="fas fa-history"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center">No diary entries found.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Pagination Controls -->
            {% if page_obj.has_other_pages %}
            <div class="pagination">
                {% if page_obj.has_previous %}
                    <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page=1" class="page-btn">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                    <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}" class="page-btn">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                {% else %}
                    <button class="page-btn disabled">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                {% endif %}
                
                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                        <button class="page-btn active">{{ num }}</button>
                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                        <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}" class="page-btn">{{ num }}</a>
                    {% endif %}
                {% endfor %}
                
                {% if page_obj.has_next %}
                    <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}" class="page-btn">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                    <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.paginator.num_pages }}" class="page-btn">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                {% else %}
                    <button class="page-btn disabled">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                {% endif %}
            </div>
            {% endif %}
            
            <!-- Modal for Viewing Entry Details -->
            <div class="modal" id="viewEntryModal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Entry Details</h2>
                        <button class="modal-close" id="closeViewModal">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body" id="modalContent">
                        <!-- Content will be dynamically inserted here -->
                    </div>
                </div>
            </div>

            <!-- Add Revision Modal after the viewEntryModal -->
            <div class="modal" id="revisionModal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>
                            <i class="fas fa-history"></i>
                            Submit Revision
                        </h2>
                        <button class="modal-close" id="closeRevisionModal">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="revisionForm">
                            <div class="form-section">
                                <h3><i class="fas fa-info-circle"></i> Revision Details</h3>
                                
                                <div class="form-group">
                                    <label for="revisionDate">Revision Date *</label>
                                    <input type="date" id="revisionDate" name="revisionDate" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="revisionType">Revision Type *</label>
                                    <select id="revisionType" name="revisionType" required>
                                        <option value="">Select type</option>
                                        <option value="correction">Data Correction</option>
                                        <option value="update">Progress Update</option>
                                        <option value="addition">Additional Information</option>
                                        <option value="documentation">Documentation Update</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Sections Revised *</label>
                                    <div class="checkbox-group">
                                        <label><input type="checkbox" name="sections" value="weather"> Weather Data</label>
                                        <label><input type="checkbox" name="sections" value="personnel"> Personnel</label>
                                        <label><input type="checkbox" name="sections" value="materials"> Materials</label>
                                        <label><input type="checkbox" name="sections" value="work"> Work Performed</label>
                                        <label><input type="checkbox" name="sections" value="delays"> Delays/Issues</label>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="revisionImpact">Impact Level</label>
                                    <select id="revisionImpact" name="revisionImpact">
                                        <option value="">Select impact</option>
                                        <option value="minor">Minor (no impact)</option>
                                        <option value="moderate">Moderate (small adjustments)</option>
                                        <option value="major">Major (significant changes)</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="revisionDescription">Revision Description *</label>
                                    <textarea id="revisionDescription" name="revisionDescription" rows="4" 
                                              placeholder="Describe the revision details, including what changes were made and why..." required></textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label>Supporting Documents</label>
                                    <input type="file" id="supportingDocs" name="supportingDocs" multiple>
                                    <small class="form-text">Upload any documents that support this revision (max 5 files)</small>
                                </div>
                            </div>
                            
                            <div class="form-section">
                                <h3><i class="fas fa-user-tie"></i> Client Approval</h3>
                                <div class="form-group">
                                    <label for="clientName">Client Name *</label>
                                    <input type="text" id="clientName" name="clientName" 
                                           placeholder="Enter client name" required>
                                </div>
                                
                                <div class="form-group">
                                    <label>Client Signature *</label>
                                    <div class="photo-upload-container">
                                        <div class="photo-preview" id="clientSignaturePreview">
                                            <i class="fas fa-signature"></i>
                                            <span>No signature selected</span>
                                        </div>
                                        <div class="photo-upload">
                                            <input type="file" id="clientSignature" name="clientSignature" 
                                                   accept="image/*" required>
                                            <label for="clientSignature" class="upload-btn">
                                                <i class="fas fa-upload"></i> Upload Signature
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-section">
                                <h3><i class="fas fa-users"></i> Project Team</h3>
                                <div class="form-group">
                                    <label for="projectTeam">Project Team Leader *</label>
                                    <input type="text" id="projectTeam" name="projectTeam" 
                                           placeholder="Enter name of team leader" required>
                                </div>
                                
                                <div class="form-group">
                                    <label>Team Leader Signature *</label>
                                    <div class="photo-upload-container">
                                        <div class="photo-preview" id="teamPhotoPreview">
                                            <i class="fas fa-signature"></i>
                                            <span>No signature selected</span>
                                        </div>
                                        <div class="photo-upload">
                                            <input type="file" id="teamPhoto" name="teamPhoto" 
                                                   accept="image/*" required>
                                            <label for="teamPhoto" class="upload-btn">
                                                <i class="fas fa-upload"></i> Upload Signature
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
  
                        </form>
                    </div>
                </div>
            </div>

        </div>
    </div> 
  
    
    <script src="{% static 'js/sitejs/history.js' %}"></script>
    {% include "site_diary/navtemplate/layoutfooter.html" %}
{% endblock %}