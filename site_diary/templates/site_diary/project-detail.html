{% extends "site_diary/layout_format.html" %}
{% load static %}

{% block head %}
    <title>Project Details - {{ project.name|default:"Harbor Tower" }} | Triple G BuildHub</title>
    <link rel="stylesheet" href="{% static 'css/sitecss/global-footer.css' %}">
    <link rel="stylesheet" href="{% static 'css/sitecss/siteproject-detail.css' %}">
       <link rel="stylesheet" href="{% static 'css/sitecss/dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'css/sitecss/createblog.css' %}">
    <link rel="stylesheet" href="{% static 'css/sitecss/header-container.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block body %}
    <div class="container">
         <div class="dashboard-header">
            <div class="dashboard-title">
                <i class="fas fa-tachometer-alt"></i>
                <h1>Project Dashboard</h1>
            </div>
            <div class="user-info">
                <div class="user-greeting">
                    <div class="user-name">{{ user_company|default:"Triple G Design Studio" }}</div>
                    <div class="user-role">{% if user.is_staff %}Site Manager{% else %}Project Member{% endif %}</div>
                </div>
                {% if user_profile_image %}
                    <img src="{{ user_profile_image }}" alt="Profile" class="user-avatar-img">
                {% else %}
                    <div class="user-avatar">{{ user.first_name.0|default:user.email.0|upper }}{{ user.last_name.0|default:'' }}</div>
                {% endif %}
            </div>
        </div>
   
        <!-- Project Header Section -->
        <div class="project-header-section">
            <!-- Project Summary Header -->
            <div class="project-header">
                <div class="project-image-container">
                    {% if project.image_url %}
                        <img src="{{ project.image_url }}" alt="{{ project.name }}" class="project-image" id="projectImage">
                    {% elif project.image %}
                        <img src="{{ project.image.url }}" alt="{{ project.name }}" class="project-image" id="projectImage">
                    {% else %}
                        <img src="{% static 'images/image6.jpg' %}" alt="{{ project.name }}" class="project-image" id="projectImage">
                    {% endif %}
                    {% if user.sitemanagerprofile.site_role.name == 'architect' %}
                    <div class="image-overlay">
                        <button class="change-image-btn" onclick="openImageGallery()">
                            <i class="fas fa-camera"></i> Change Image
                        </button>
                    </div>
                    {% endif %}
                </div>
                <div class="project-info">
                    <div class="project-title-section">
                        <h1 class="project-title">{{ project.name|default:"Harbor Tower" }}</h1>
                        <span class="project-code">{{ project.code|default:"HT-2024-001" }}</span>
                        <span class="status-badge status-{{ project.status|default:'active' }}">
                            {{ project.get_status_display|default:"Active" }}
                        </span>
                    </div>
                    <div class="client-info">
                        <div class="info-item">
                            <i class="fas fa-user"></i>
                            <span>{{ project.client_name }}</span>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-hard-hat"></i>
                            <span>Site Manager: {{ project.project_manager.get_full_name|default:project.project_manager.username }}</span>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>{{ project.location }}</span>
                        </div>
                    </div>
                </div>
                <div class="project-dates">
                    <div class="date-item">
                        <span class="date-label">Start Date</span>
                        <span class="date-value">{{ project.start_date|date:"M d, Y" }}</span>
                    </div>
                    <div class="date-item">
                        <span class="date-label">Target Completion</span>
                        <span class="date-value">{{ project.expected_end_date|date:"M d, Y" }}</span>
                    </div>
                    <div class="date-item">
                        <span class="date-label">Current Phase</span>
                        <span class="date-value">{{ phase_name }}</span>
                    </div>
                </div>
            </div>

            <!-- Progress Overview Sidebar -->
            <div class="progress-overview-sidebar">
                <h3 class="sidebar-title">
                    <i class="fas fa-chart-line"></i> Progress Overview
                </h3>
                <div class="progress-content">
                    <div class="circular-progress">
                        <div class="progress-circle" data-progress="{{ progress }}">
                            <span class="progress-text">{{ progress|floatformat:0 }}%</span>
                        </div>
                    </div>
                    <div class="milestone-progress">
                        {% for milestone in project.milestones %}
                        <div class="milestone-item {{ milestone.status }}">
                            <span class="milestone-name">{{ milestone.name }}</span>
                            <div class="milestone-bar">
                                <div class="milestone-fill" style="width: {{ milestone.progress_width|floatformat:0 }}%"></div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="milestone-item active">
                            <span class="milestone-name">In Progress</span>
                            <div class="milestone-bar">
                                <div class="milestone-fill" style="width: {{ progress|floatformat:0 }}%"></div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <button class="btn btn-outline" onclick="openTimelineModal()">
                    <i class="fas fa-timeline"></i> View Timeline
                </button>
            </div>
        </div>

        <!-- Budget and Labor Section -->
        <div class="budget-labor-container">
            <!-- Labor & Equipment Section -->
            <div class="labor-equipment-section">
                <h3 class="section-title">
                    <i class="fas fa-hard-hat"></i> Labor & Equipment
                </h3>
                <div class="resource-stats">
                    <div class="stat-item">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info">
                            <span class="stat-number">{{ labor_count }}</span>
                            <span class="stat-label">Total Workers</span>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon">
                            <i class="fas fa-tools"></i>
                        </div>
                        <div class="stat-info">
                            <span class="stat-number">{{ equipment_count }}</span>
                            <span class="stat-label">Equipment Units</span>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="stat-info">
                            <span class="stat-number">{{ delays_count }}</span>
                            <span class="stat-label">Logged Delays</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Budget Tracking Section -->
            <div class="budget-tracking-section">
                <h3 class="section-title">
                    <i class="fas fa-dollar-sign"></i> Budget Tracking
                </h3>
                <div class="budget-content">
                    <div class="budget-chart">
                        <div class="chart-container">
                            <canvas id="budgetChart" width="300" height="300"></canvas>
                        </div>
                    </div>
                    <div class="budget-info">
                        <h4 class="budget-summary-title">Budget Summary</h4>
                        <div class="budget-summary">
                            <div class="budget-item">
                                <span class="budget-label">Total Budget</span>
                                <span class="budget-value total">₱{{ total_budget|floatformat:2 }}</span>
                            </div>
                            <div class="budget-item">
                                <span class="budget-label">Total Spent</span>
                                <span class="budget-value spent">₱{{ total_spent|floatformat:2 }}</span>
                            </div>
                            <div class="budget-item">
                                <span class="budget-label">Remaining</span>
                                <span class="budget-value remaining">₱{{ remaining_budget|floatformat:2 }}</span>
                            </div>
                        </div>
                        <a href="{% url 'site_diary:reports' %}?project={{ project.id }}" class="btn btn-primary">
                            <i class="fas fa-file-invoice-dollar"></i> Generate Report
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="detail-grid">

            <!-- Site Diary Summary -->
            <div class="detail-card diary-card">
                <h3 class="card-title">
                    <i class="fas fa-book"></i> Recent Site Diary Entries
                </h3>
                <div class="diary-entries">
                    {% for entry in recent_diary_entries %}
                    <div class="diary-entry">
                        <div class="entry-date">{{ entry.entry_date|date:"M d, Y" }}</div>
                        <div class="entry-summary">{{ entry.work_description|truncatechars:80 }}</div>
                        <div class="entry-progress">Progress: {{ entry.progress_percentage|floatformat:0 }}%</div>
                    </div>
                    {% empty %}
                    <div class="diary-entry">
                        <div class="entry-summary">No diary entries found for this project.</div>
                    </div>
                    {% endfor %}
                </div>
                <a href="{% url 'site_diary:diary' %}" class="btn btn-outline">
                    <i class="fas fa-external-link-alt"></i> View Full Diary Log
                </a>
            </div>



            <!-- Team Members -->
            <div class="detail-card files-card">
                <h3 class="card-title">
                    <i class="fas fa-users"></i> Team Members
                </h3>
                <div class="files-list">
                    {% if lead_architect %}
                    <div class="file-item team-lead">
                        <div class="file-info">
                            <i class="fas fa-drafting-compass"></i>
                            <span class="file-name">{{ lead_architect.get_full_name|default:lead_architect.username }}</span>
                            <span class="lead-badge">Lead</span>
                        </div>
                        <div class="file-meta">
                            <span class="file-date">Lead Architect</span>
                        </div>
                    </div>
                    {% endif %}
                    

                    
                    {% for member in team_members %}
                    <div class="file-item">
                        <div class="file-info">
                            {% if member.role == 'foreman' %}
                                <i class="fas fa-hard-hat"></i>
                            {% elif member.role == 'engineer' or member.role == 'site_engineer' %}
                                <i class="fas fa-tools"></i>
                            {% elif member.role == 'supervisor' %}
                                <i class="fas fa-eye"></i>
                            {% else %}
                                <i class="fas fa-user"></i>
                            {% endif %}
                            <span class="file-name">{{ member.user.get_full_name|default:member.user.username }}</span>
                        </div>
                        <div class="file-meta">
                            <span class="file-date">{{ member.get_role_display }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <button class="btn btn-outline">
                    <i class="fas fa-user-plus"></i> Add Team Member
                </button>
            </div>
        </div>
    </div>

    <!-- Timeline Modal -->
    <div id="timelineModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Project Timeline</h3>
                <span class="modal-close" onclick="closeTimelineModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="timeline">
                    <div class="timeline-item completed">
                        <div class="timeline-dot"></div>
                        <div class="timeline-content">
                            <h4>Project Planning</h4>
                            <span class="timeline-date">Jan 15 - Feb 28, 2024</span>
                            <p>Initial planning, permits, and design finalization completed.</p>
                        </div>
                    </div>
                    <div class="timeline-item completed">
                        <div class="timeline-dot"></div>
                        <div class="timeline-content">
                            <h4>Foundation Work</h4>
                            <span class="timeline-date">Mar 1 - May 15, 2024</span>
                            <p>Excavation, foundation laying, and structural groundwork completed.</p>
                        </div>
                    </div>
                    <div class="timeline-item active">
                        <div class="timeline-dot"></div>
                        <div class="timeline-content">
                            <h4>Structural Construction</h4>
                            <span class="timeline-date">May 16 - Sep 30, 2024</span>
                            <p>Main structure, steel framework, and concrete work in progress.</p>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-dot"></div>
                        <div class="timeline-content">
                            <h4>Finishing Work</h4>
                            <span class="timeline-date">Oct 1 - Dec 20, 2024</span>
                            <p>Interior finishing, utilities installation, and final inspections.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Gallery Modal -->
    <div id="imageGalleryModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3><i class="fas fa-images"></i> Select Project Image</h3>
                <span class="modal-close" onclick="closeImageGallery()">&times;</span>
            </div>
            <div class="modal-body" style="max-height: 500px; overflow-y: auto;">
                <div style="padding: 15px; border-bottom: 1px solid #ddd;">
                    <button onclick="document.getElementById('deviceImageInput').click()" style="background: #3c6e71; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; width: 100%;">
                        <i class="fas fa-upload"></i> Browse on Your Device
                    </button>
                    <input type="file" id="deviceImageInput" accept="image/*" style="display: none;" onchange="uploadDeviceImage(this)">
                </div>
                <div id="galleryGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; padding: 20px;">
                    <div style="grid-column: 1/-1; text-align: center; color: #666;">Loading gallery...</div>
                </div>
            </div>
        </div>
    </div>

    <script src="{% static 'js/sitejs/project-detail.js' %}"></script>
    
    <style>
    .budget-labor-container {
        display: flex;
        gap: 24px;
        margin-bottom: 24px;
    }
    .labor-equipment-section, .budget-tracking-section {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .labor-equipment-section {
        flex: 1;
    }
    .budget-tracking-section {
        flex: 2;
    }
    .budget-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 32px;
        align-items: center;
    }
    .budget-chart {
        display: flex;
        justify-content: center;
     
        height: 100%;
    }
    .budget-info {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    .section-title {
        margin: 0 0 20px 0;
        font-size: 1.5rem;
        color: #333;
    }
    .resource-stats {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    .user-avatar-img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
    }
    .budget-summary-title {
        text-align: center;
        margin: -85px 0 16px 0;
        font-size: 1.3rem;
        color: #333;
        font-weight: 600;
    }
    .project-image-container {
        position: relative;
        overflow: hidden;
        border-radius: 8px;
    }
    .project-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
    }
    .project-image-container:hover .project-image {
        transform: scale(1.05);
    }
    .image-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    .project-image-container:hover .image-overlay {
        opacity: 1;
    }
    .change-image-btn {
        background: #007cba;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.3s ease;
    }
    .change-image-btn:hover {
        background: #005a8a;
    }
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }
    .modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    #galleryGrid img {
        width: 100%;
        height: 150px;
        object-fit: cover;
        cursor: pointer;
        border: 2px solid transparent;
        border-radius: 4px;
        transition: border-color 0.3s;
    }
    #galleryGrid img:hover {
        border-color: #007cba;
    }
    
    /* Team Members Styles */
    .team-lead {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-left: 4px solid #007cba;
    }
    
    .lead-badge {
        background: #007cba;
        color: white;
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 10px;
        margin-left: 8px;
        font-weight: 600;
    }
    
    .file-item {
        transition: all 0.3s ease;
    }
    
    .file-item:hover {
        background: #f8f9fa;
        transform: translateX(5px);
    }
    
    .team-lead:hover {
        background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
    }
    </style>
    
    <script>
    function openImageGallery() {
        const modal = document.getElementById('imageGalleryModal');
        modal.style.display = 'flex';
        loadArchitectGallery();
    }
    
    function closeImageGallery() {
        const modal = document.getElementById('imageGalleryModal');
        modal.style.display = 'none';
    }
    
    function loadArchitectGallery() {
        const galleryGrid = document.getElementById('galleryGrid');
        galleryGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #666;">Loading gallery...</div>';
        
        fetch('/accounts/api/architect-gallery/{{ user.id }}/')
            .then(response => response.json())
            .then(data => {
                if (data.images && data.images.length > 0) {
                    galleryGrid.innerHTML = '';
                    data.images.forEach(image => {
                        const img = document.createElement('img');
                        img.src = image.url;
                        img.onclick = function() {
                            updateProjectImage(image.url);
                        };
                        galleryGrid.appendChild(img);
                    });
                } else {
                    galleryGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #666;">No images in gallery</div>';
                }
            })
            .catch(error => {
                console.error('Error loading gallery:', error);
                galleryGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #f44;">Error loading gallery</div>';
            });
    }
    
    function uploadDeviceImage(input) {
        if (input.files && input.files[0]) {
            const formData = new FormData();
            formData.append('image_file', input.files[0]);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            
            fetch('{% url "site_diary:update_project_image" project.id %}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('projectImage').src = data.image_url;
                    closeImageGallery();
                } else {
                    alert('Error uploading image');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error uploading image');
            });
        }
    }
    
    function updateProjectImage(imageUrl) {
        const formData = new FormData();
        formData.append('image_url', imageUrl);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        
        fetch('{% url "site_diary:update_project_image" project.id %}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('projectImage').src = imageUrl;
                closeImageGallery();
            } else {
                alert('Error updating image');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating image');
        });
    }
    
    window.onclick = function(event) {
        const modal = document.getElementById('imageGalleryModal');
        if (event.target === modal) {
            closeImageGallery();
        }
    }
    </script>
    
    {% include "site_diary/navtemplate/layoutfooter.html" %}
{% endblock %}