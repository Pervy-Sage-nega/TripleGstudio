{% extends "site_diary/layout_format.html" %}
{% load static %}

{% block title %}Triple G BuildHub - Dashboard{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/sitecss/header-container.css' %}">
    <link rel="stylesheet" href="{% static 'css/sitecss/global-footer.css' %}">
    <link rel="stylesheet" href="{% static 'css/sitecss/dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'css/sitecss/createblog.css' %}">
    <link rel="stylesheet" href="{% static 'css/sitecss/milestone-scroll.css' %}">
    
    
{% endblock %}

{% block body %}
    <div class="container">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <div class="dashboard-title">
                <i class="fas fa-tachometer-alt"></i>
                <h1>Project Dashboard</h1>
            </div>
            <div class="user-info">
                <div class="user-greeting">
                    <div class="user-name">{{ user.get_full_name|default:user.email }}</div>
                    <div class="user-role">{% if user.is_staff %}Site Manager{% else %}Project Member{% endif %}</div>
                </div>
                <div class="user-avatar">{{ user.first_name.0|default:user.email.0|upper }}{{ user.last_name.0|default:'' }}</div>
            </div>
        </div>
        
        <!-- Dashboard Stats -->
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-building"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value">{{ stats.total_projects }}</div>
                    <div class="stat-label">Total Projects</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value">{{ stats.active_projects }}</div>
                    <div class="stat-label">Active Projects</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-pause-circle"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value">{{ stats.at_risk }}</div>
                    <div class="stat-label">At Risk</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-edit"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value">{{ stats.draft_entries }}</div>
                    <div class="stat-label">Draft Entries</div>
                </div>
            </div>
        </div>

        <!-- Dashboard Controls -->
        <div class="dashboard-controls">
            <div class="controls-title">Site Manager Projects</div>
            <div class="filter-controls">
                <select class="filter-dropdown" id="categoryFilter">
                    <option value="">All Categories</option>
                    <option value="commercial">Commercial</option>
                    <option value="residential">Residential</option>
                    <option value="industrial">Industrial</option>
                    <option value="infrastructure">Infrastructure</option>
                </select>
                <select class="filter-dropdown" id="statusFilter">
                    <option value="">All Statuses</option>
                    <option value="active">Active</option>
                    <option value="completed">Completed</option>
                    <option value="delayed">Delayed</option>
                    <option value="planning">Planning</option>
                </select>
                <div class="search-box">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" id="projectSearch" placeholder="Search by project name or code...">
                </div>
                <button class="btn btn-primary" onclick="window.location.href='{% url 'site_diary:newproject' %}'">
                    <i class="fas fa-plus"></i> New Project
                </button>
            </div>
        </div>
        
        <!-- Project Grid -->
        <div class="project-grid">
            {% for project in projects %}
            <div class="project-card" data-category="{{ project.category|default:'commercial' }}" data-status="{{ project.status }}">
                {% if project.image %}
                    <img src="{{ project.image.url }}" alt="{{ project.name }}" class="project-image">
                {% else %}
                    <img src="{% static 'images/image6.jpg' %}" alt="{{ project.name }}" class="project-image">
                {% endif %}
                <div class="project-content">
                    <h3 class="project-title">{{ project.name }}</h3>
                    <p class="project-description">{{ project.description|default:'Project in progress with multiple phases and milestones.'|truncatechars:80 }}</p>
                    <div class="progress-container">
                        <div class="progress-header">
                            <div class="progress-label">CURRENT MILESTONE:</div>
                            <div class="milestone-info">
                                <span class="current-milestone">{{ project.current_milestone|default:'Not Set' }}</span>
                                {% if project.milestone_completion > 0 %}
                                <span class="milestone-progress">({{ project.milestone_completion|floatformat:0 }}% Complete)</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="milestone-markers" style="overflow-x: auto; white-space: nowrap; display: flex; gap: 10px; padding-bottom: 5px; scrollbar-width: none; -ms-overflow-style: none;">
                            {% for milestone in project.milestones %}
                            <div class="milestone {% if milestone.is_completed %}completed{% elif milestone.is_current %}current{% endif %}">
                                <div class="milestone-progress-bar">
                                    {% if milestone.is_completed %}
                                    <div class="milestone-progress-fill" style="width: 100%;"></div>
                                    {% elif milestone.is_current %}
                                    <div class="milestone-progress-fill" style="width: {{ milestone.completion_percentage|floatformat:0 }}%;"></div>
                                    {% else %}
                                    <div class="milestone-progress-fill" style="width: 0%;"></div>
                                    {% endif %}
                                </div>
                                <div class="milestone-dot"></div>
                                <div class="milestone-label">{{ milestone.name }}</div>
                            </div>
                            {% empty %}
                            <div class="milestone {% if project.progress > 0 %}completed{% endif %}">
                                <div class="milestone-dot"></div>
                                <div class="milestone-label">In Progress</div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="card-actions">
                        <a href="{% url 'site_diary:project_detail' project.id %}" class="btn btn-outline">
                            <i class="fas fa-folder-open"></i> View Details
                        </a>
                        <a href="{% url 'site_diary:diary_logs' %}?project={{ project.id }}" class="btn btn-secondary">
                            <i class="fas fa-book"></i> Diary Logs
                        </a>
                        <a href="{% url 'site_diary:reports' %}?project={{ project.id }}" class="btn btn-primary">
                            <i class="fas fa-chart-bar"></i> Reports
                        </a>
                    </div>
                </div>
                <div class="performance-analytics">
                    <h4 class="analytics-title">Performance Analytics</h4>
                    <div class="analytics-item">
                        <span class="analytics-label">Budget Usage:</span>
                        <span class="analytics-value {{ project.budget_health }}">{% if project.budget_used < 1 %}{{ project.budget_used|floatformat:2 }}{% else %}{{ project.budget_used|floatformat:0 }}{% endif %}% Used</span>
                    </div>
                    <div class="analytics-item">
                        <span class="analytics-label">Schedule Adherence:</span>
                        <span class="analytics-value {% if project.schedule_status == 'On Track' %}good{% elif project.schedule_status == 'Minor Delays' %}warning{% else %}danger{% endif %}">{{ project.schedule_status }}</span>
                    </div>
                    {% if project.revision_count > 0 %}
                    <div class="analytics-item revision-impact">
                        <span class="analytics-label">Revisions Impact:</span>
                        <span class="analytics-value warning">
                            {{ project.revision_count }} revision{{ project.revision_count|pluralize }}
                            <small>(+â‚±{{ project.revision_cost_impact|floatformat:0 }})</small>
                        </span>
                    </div>
                    {% endif %}
                    {% if project.budget_variance > 5 %}
                    <div class="analytics-item budget-variance">
                        <span class="analytics-label">Budget Variance:</span>
                        <span class="analytics-value {% if project.budget_variance > 15 %}danger{% elif project.budget_variance > 10 %}warning{% else %}good{% endif %}">
                            +{{ project.budget_variance|floatformat:1 }}%
                        </span>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <div class="no-projects">
                <p>No projects found. <a href="{% url 'site_diary:newproject' %}">Create your first project</a></p>
            </div>
            {% endfor %}


           
        </div>
        
    </div>

    <!-- Project Approval Modal -->
    {% if approval_modal_data %}
    <div id="approvalModal" class="modal-backdrop">
        <div class="modal-content approval-modal">
            <div class="modal-header">
                <div class="modal-icon success">
                    <i class="fas fa-clock"></i>
                </div>
                <h3>Project Submitted for Approval</h3>
                <button class="modal-close" onclick="closeApprovalModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="approval-message">
                    <h4>{{ approval_modal_data.project_name }}</h4>
                    <p>Your project has been successfully submitted and is now waiting for admin approval.</p>
                    <div class="approval-details">
                        <div class="detail-item">
                            <i class="fas fa-info-circle"></i>
                            <span>You will be notified via email once your project is approved</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-eye"></i>
                            <span>You can track the approval status in your dashboard</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-clock"></i>
                            <span>Approval typically takes 1-2 business days</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeApprovalModal()">Got it, thanks!</button>
            </div>
        </div>
    </div>
    {% endif %}
   

    <!-- Scripts -->
    <script src="{% static 'js/sitejs/sitemanager-dashboard.js' %}"></script>
    <script src="{% static 'js/sitejs/dashboardjs' %}"></script>
    
    {% if approval_modal_data %}
    <script>
        function closeApprovalModal() {
            document.getElementById('approvalModal').style.display = 'none';
        }
        
        // Show modal on page load
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('approvalModal').style.display = 'flex';
        });
    </script>
    {% endif %}
    
    <!-- loader.js will be loaded by loader-init.js -->
    {% include "site_diary/navtemplate/layoutfooter.html" %}
{% endblock %}
