{% extends "layout.html" %}
{% load static %}

{% block head %}
    <title>{{ project.name }} - Project Details</title>
    <link rel="stylesheet" href="{% static 'css/sitecss/global-footer.css' %}">
    <link rel="stylesheet" href="{% static 'css/sitecss/clientdashboard.css' %}">
    <link rel="stylesheet" href="{% static 'css/home.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block body %}
    <div class="container">
        <!-- Header -->
        <div class="dashboard-header">
            <div class="dashboard-title">
                <i class="fas fa-building"></i>
                <h1>{{ project.name }}</h1>
            </div>
            <div class="project-actions">
                <a href="{% url 'core:clientdashboard' %}" style="display: inline-block; background-color: #FF7120; color: white; padding: 6px 15px; border-radius: 10px; font-size: 14px; font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase; transition: all 0.3s ease; text-decoration: none;">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </div>

        <!-- Project Overview -->
        <div class="project-overview-section">
            <div class="project-card main-project">
                <img src="{% if project.image %}{{ project.image.url }}{% else %}{% static 'images/image6.jpg' %}{% endif %}" alt="{{ project.name }} Image" class="project-image">
                <div class="project-content">
                    <div class="project-header">
                        <h3 class="project-title">{{ project.name }}</h3>
                    </div>
                    <p class="project-description">{{ project.description|default:"Construction project in progress" }}</p>
                    <div class="project-meta">
                        <div class="meta-item">
                            <i class="fas fa-user-tie"></i>
                            <span>{{ project.project_manager.get_full_name|default:project.project_manager.username }}</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-calendar"></i>
                            <span>{{ project.start_date|date:"M Y" }}{% if project.expected_end_date %} - {{ project.expected_end_date|date:"M Y" }}{% else %} - Ongoing{% endif %}</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-cog"></i>
                            <span>{{ project.get_status_display }}</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>{{ project.location }}</span>
                        </div>
                    </div>
                </div>
                <div class="progress-circle-container">
                    <div class="project-code">PRJ-{{ project.created_at.year }}-{{ project.id|stringformat:"03d" }}</div>
                    <div class="progress-circle" style="--progress-deg: {% widthratio project.get_progress_percentage 100 360 %}deg;">
                        <div class="progress-value">{{ project.get_progress_percentage }}%</div>
                        <div class="progress-label">Complete</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Progress Analytics Section -->
        <div class="analytics-section">
            <div class="analytics-card">
                <div class="analytics-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="analytics-content">
                    <div class="analytics-value">{% if current_milestone %}{{ current_milestone_progress|floatformat:0 }}%{% else %}0%{% endif %}</div>
                    <div class="analytics-label">{% if current_milestone %}{{ current_milestone.name }}{% else %}Current Phase{% endif %}</div>
                </div>
            </div>
            <div class="analytics-card">
                <div class="analytics-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="analytics-content">
                    <div class="analytics-value">{% if project.expected_end_date %}{{ project.expected_end_date|timeuntil }}{% else %}TBD{% endif %}</div>
                    <div class="analytics-label">Days Remaining</div>
                </div>
            </div>
            <div class="analytics-card">
                <div class="analytics-icon">
                    <i class="fas fa-dollar-sign"></i>
                </div>
                <div class="analytics-content">
                    <div class="analytics-value">{% if budget_percentage < 1 %}{{ budget_percentage|floatformat:2 }}%{% else %}{{ budget_percentage|floatformat:0 }}%{% endif %}</div>
                    <div class="analytics-label">Budget Used</div>
                </div>
            </div>
            <div class="analytics-card">
                <div class="analytics-icon">
                    <i class="fas fa-tasks"></i>
                </div>
                <div class="analytics-content">
                    <div class="analytics-value">{{ completed_phases }}/{{ total_phases }}</div>
                    <div class="analytics-label">Phases Complete</div>
                </div>
            </div>
        </div>

        <!-- Milestone Timeline Section -->
        <div class="timeline-section">
            <h2 class="section-title">Project Timeline</h2>
            <div class="timeline-container" style="overflow-x: auto; white-space: nowrap; display: flex; gap: 20px; padding-bottom: 10px; scrollbar-width: none; -ms-overflow-style: none;">
                <style>.timeline-container::-webkit-scrollbar { display: none; }</style>
                {% for milestone in milestones %}
                {% with progress=milestone_progress|default_if_none:0 %}
                <div class="milestone {% if progress == 100 %}completed{% elif progress > 0 %}current{% else %}pending{% endif %}" style="min-width: 350px; max-width: 350px; flex-shrink: 0;">
                    <div class="milestone-dot"></div>
                    <div class="milestone-content" style="white-space: normal;">
                        <h4 style="white-space: normal;">{{ milestone.name }}</h4>
                        <span class="status-badge {% if progress == 100 %}completed{% elif progress > 0 %}in-progress{% else %}pending{% endif %}">
                            {% if progress == 100 %}Completed{% elif progress > 0 %}{{ progress|floatformat:0 }}% In Progress{% else %}Pending{% endif %}
                        </span>
                    </div>
                </div>
                {% endwith %}
                {% empty %}
                <div class="milestone current" style="min-width: 200px; flex-shrink: 0;">
                    <div class="milestone-dot"></div>
                    <div class="milestone-content">
                        <h4>In Progress</h4>
                        <p>Project ongoing</p>
                        <span class="status-badge in-progress">Active</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Activity Feed and Budget Summary -->
        <div class="bottom-section">
            <!-- Activity Feed -->
            <div class="activity-section">
                <h2 class="section-title">Recent Updates</h2>
                <div class="activity-feed">
                    {% for entry in diary_entries %}
                    <div class="activity-item">
                        <div class="activity-date">{{ entry.entry_date|date:"M d, Y" }}</div>
                        <div class="activity-content">
                            <h4>{% if entry.milestone %}{{ entry.milestone.name }}{% else %}Daily Update{% endif %} - {{ entry.progress_percentage }}% Complete</h4>
                            <p>{{ entry.work_description|truncatewords:20 }}</p>
                            {% if entry.weather_condition %}<small><i class="fas fa-cloud"></i> {{ entry.get_weather_condition_display }}</small>{% endif %}
                        </div>
                        <div class="activity-icon">
                            <i class="fas fa-{% if entry.progress_percentage == 100 %}check-circle{% else %}hammer{% endif %}"></i>
                        </div>
                    </div>
                    {% empty %}
                    <div class="activity-item">
                        <div class="activity-date">{{ project.created_at|date:"M d, Y" }}</div>
                        <div class="activity-content">
                            <h4>Project {{ project.name }} created</h4>
                            <p>{{ project.description|default:"Project initiated and planning phase started" }}</p>
                        </div>
                        <div class="activity-icon">
                            <i class="fas fa-plus-circle"></i>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Budget Summary -->
            <div class="budget-section">
                <h2 class="section-title">Budget Summary</h2>
                <div class="budget-widget">
                    {% if project.budget %}
                    <div class="budget-item">
                        <span class="budget-label">Total Budget</span>
                        <span class="budget-value">₱{{ project.budget|floatformat:0 }}</span>
                    </div>
                    <div class="budget-item">
                        <span class="budget-label">Used</span>
                        <span class="budget-value used">₱{{ budget_used|floatformat:0 }}</span>
                    </div>
                    <div class="budget-item">
                        <span class="budget-label">Remaining</span>
                        <span class="budget-value remaining">₱{{ budget_remaining|floatformat:0 }}</span>
                    </div>
                    <div class="budget-progress">
                        <div class="budget-bar" style="width: {{ budget_percentage|floatformat:0 }}%;"></div>
                    </div>
                    {% else %}
                    <div class="budget-item">
                        <span class="budget-label">Total Budget</span>
                        <span class="budget-value">To be determined</span>
                    </div>
                    <div class="budget-item">
                        <span class="budget-label">Used</span>
                        <span class="budget-value used">-</span>
                    </div>
                    <div class="budget-item">
                        <span class="budget-label">Remaining</span>
                        <span class="budget-value remaining">-</span>
                    </div>
                    <div class="budget-progress">
                        <div class="budget-bar" style="width: 0%;"></div>
                    </div>
                    {% endif %}
                </div>

                <!-- Weather Widget -->
                <div class="weather-widget">
                    <h3>Site Weather - {{ project.location|default:"Project Site" }}</h3>
                    {% if latest_weather %}
                    <div class="weather-content">
                        <div class="weather-icon">
                            <i class="fas fa-{% if latest_weather.weather_condition == 'sunny' %}sun{% elif latest_weather.weather_condition == 'rainy' %}cloud-rain{% elif latest_weather.weather_condition == 'cloudy' %}cloud{% elif latest_weather.weather_condition == 'stormy' %}bolt{% else %}cloud-sun{% endif %}"></i>
                        </div>
                        <div class="weather-info">
                            <div class="temperature">{% if latest_weather.temperature_high %}{{ latest_weather.temperature_high }}°C{% if latest_weather.temperature_low %} / {{ latest_weather.temperature_low }}°C{% endif %}{% else %}N/A{% endif %}</div>
                            <div class="condition">{{ latest_weather.get_weather_condition_display }}</div>
                            <div class="humidity">{% if latest_weather.humidity %}Humidity: {{ latest_weather.humidity }}%{% endif %} {% if latest_weather.wind_speed %}Wind: {{ latest_weather.wind_speed }} km/h{% endif %}</div>
                            <small style="color: #888;">Last updated: {{ latest_weather.entry_date|date:"M d, Y" }}</small>
                        </div>
                    </div>
                    {% else %}
                    <div class="weather-content">
                        <div class="weather-icon">
                            <i class="fas fa-cloud-sun"></i>
                        </div>
                        <div class="weather-info">
                            <div class="temperature">No weather data</div>
                            <div class="condition">available yet</div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <script src="{% static 'js/sitejs/clientdashboard.js' %}"></script>
{% endblock %}