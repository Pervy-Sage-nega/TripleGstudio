{% extends "site_diary/layout_format.html" %}
{% load static %}

{% block head %}
    <title>Site Diary Drafts - Triple G BuildHub</title>
    <link rel="stylesheet" href="{% static 'css/sitecss/drafts.css' %}">
    <link rel="stylesheet" href="{% static 'css/sitecss/createblog.css' %}">

    <link rel="stylesheet" href="{% static 'css/admincss/nav.css' %}">
    <link rel="stylesheet" href="{% static 'css/sitecss/header-container.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block body %}
    {% csrf_token %}
    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <div class="page-title">
                <i class="fas fa-file-alt"></i>
                <h1>Site Diary Drafts</h1>
            </div>
            <div class="user-info">
                <div class="user-greeting">
                    <div class="user-name">{{ user.get_full_name|default:user.username }}</div>
                    <div class="user-role">Site Manager</div>
                </div>
                <div class="user-avatar">{{ user.first_name.0|default:user.username.0|upper }}{{ user.last_name.0|default:""|upper }}</div>
            </div>
        </div>

        <!-- Dashboard Stats -->
        <div class="stats-container">
            <!-- Stat Card 1 -->
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-pencil-alt"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="drafts-count">{{ stats.total_drafts }}</div>
                    <div class="stat-label">Saved Diary Drafts</div>
                </div>
            </div>

            <!-- Stat Card 2 -->
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="recent-count">{{ stats.recent_drafts }}</div>
                    <div class="stat-label">Recent Drafts (7 days)</div>
                </div>
            </div>

            <!-- Stat Card 3 -->
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-paper-plane"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="submitted-count">{{ stats.submitted_entries }}</div>
                    <div class="stat-label">Submitted</div>
                </div>
            </div>
        </div>

        <!-- Drafts Controls -->
        <div class="drafts-controls">
            <div class="controls-title">My Diary Entry Drafts</div>
            <div class="filter-controls">
                <select class="filter-dropdown" id="category-filter">
                    <option value="">All Categories</option>
                    <option value="materials">Materials</option>
                    <option value="equipment">Equipment</option>
                    <option value="delays-issues">Delays/Issues</option>
                    <option value="notes">Notes</option>
                    <option value="weather">Weather</option>
                    <option value="personnel">Personnel</option>
                    <option value="safety">Safety</option>
                    <option value="progress">Progress</option>
                </select>
                <div class="search-box">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" id="search-input" placeholder="Search diary drafts...">
                </div>
                <button class="btn btn-primary new-blog-btn" onclick="location.href='{% url 'site_diary:diary' %}';">
                    <i class="fas fa-plus"></i> New Diary Entry
                </button>
            </div>
        </div>

        <!-- View Toggle -->
        <div class="view-toggle">
            <button class="view-btn active" data-view="card">
                <i class="fas fa-th"></i> Card View
            </button>
            <button class="view-btn" data-view="table">
                <i class="fas fa-list"></i> Table View
            </button>
        </div>

        <!-- Card View (Default) -->
        <div class="drafts-container card-view" id="drafts-card-view">
            {% if page_obj and page_obj|length > 0 %}
                {% for draft in page_obj %}
                <div class="draft-card" data-draft-id="{{ draft.id }}">
                    <div class="draft-header">
                        <div class="draft-category">Draft</div>
                        <div class="draft-date">
                            <i class="far fa-calendar-alt"></i> <span class="date-value">{{ draft.entry_date|date:"M d, Y" }}</span>
                        </div>
                    </div>
                    <div class="draft-body">
                        <h3 class="draft-title">{{ draft.project.name }}</h3>
                        <p class="draft-excerpt">{{ draft.work_description|truncatechars:100|default:"No description available" }}</p>
                        <div class="draft-meta">
                            <small class="text-muted">Created: {{ draft.created_at|date:"M d, Y H:i" }}</small>
                        </div>
                    </div>
                    <div class="draft-actions">
                        <a href="{% url 'site_diary:diary' %}?edit={{ draft.id }}" class="action-btn revision-btn" title="Edit Draft" data-draft-id="{{ draft.id }}">
                            <i class="fas fa-edit"></i>
                        </a>
                        <button type="button" class="action-btn delete-btn" title="Delete Draft" onclick="deleteDraft({{ draft.id }})">
                            <i class="fas fa-trash"></i>
                        </button>
                        <!-- Fallback form for non-JS users -->
                        <form method="post" style="display: none;" onsubmit="return confirm('Are you sure you want to delete this draft?');">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="delete_draft">
                            <input type="hidden" name="draft_id" value="{{ draft.id }}">
                            <button type="submit" class="action-btn delete-btn" title="Delete Draft">
                                <i class="fas fa-trash"></i>
                            </button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="no-drafts" id="no-drafts-message">
                    <i class="fas fa-file-alt"></i>
                    <h3>No Diary Drafts Found</h3>
                    <p>You haven't saved any diary entry drafts yet. Start creating a new diary entry to get started.</p>
                    <a href="{% url 'site_diary:diary' %}" class="btn btn-primary">Create New Diary Entry</a>
                </div>
            {% endif %}
        </div>

        <!-- Table View -->
        <div class="drafts-container table-view" id="drafts-table-view">
            <div class="table-responsive">
                <table id="drafts-table">
                    <thead>
                        <tr>
                            <th>Project</th>
                            <th>Date</th>
                            <th>Excerpt</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="drafts-table-body">
                        {% for draft in page_obj %}

                        <tr data-draft-id="{{ draft.id }}">
                            <td>{{ draft.project.name }}</td>
                            <td>{{ draft.entry_date|date:"M d, Y" }}</td>
                            <td>{{ draft.work_description|truncatechars:80|default:"No description" }}</td>
                            <td><span class="badge badge-warning">Draft</span></td>
                            <td>
                                <a href="{% url 'site_diary:diary' %}?edit={{ draft.id }}" class="action-btn revision-btn" title="Edit" data-draft-id="{{ draft.id }}">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button type="button" class="action-btn delete-btn" title="Delete" onclick="deleteDraft({{ draft.id }})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="5">No diary drafts found.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pagination -->
        {% if page_obj.has_other_pages %}
        <div class="pagination" id="pagination">
            {% if page_obj.has_previous %}
                <a href="?page=1" class="page-btn"><i class="fas fa-angle-double-left"></i></a>
                <a href="?page={{ page_obj.previous_page_number }}" class="page-btn"><i class="fas fa-angle-left"></i></a>
            {% endif %}
            
            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                    <span class="page-btn active">{{ num }}</span>
                {% else %}
                    <a href="?page={{ num }}" class="page-btn">{{ num }}</a>
                {% endif %}
            {% endfor %}
            
            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}" class="page-btn"><i class="fas fa-angle-right"></i></a>
                <a href="?page={{ page_obj.paginator.num_pages }}" class="page-btn"><i class="fas fa-angle-double-right"></i></a>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <script>
        // Store draft data for potential use (database-driven, not localStorage)
        window.draftData = {
            {% for draft in page_obj %}
            '{{ draft.id }}': {
                id: {{ draft.id }},
                project_id: {{ draft.project.id }},
                project_name: '{{ draft.project.name|escapejs }}',
                entry_date: '{{ draft.entry_date|date:"Y-m-d" }}',
                work_description: '{{ draft.work_description|escapejs }}',
                progress_percentage: {{ draft.progress_percentage|default:0 }},
                weather_condition: '{{ draft.weather_condition }}',
                temperature_high: {{ draft.temperature_high|default:'null' }},
                temperature_low: {{ draft.temperature_low|default:'null' }},
                humidity: {{ draft.humidity|default:'null' }},
                wind_speed: {{ draft.wind_speed|default:'null' }},
                quality_issues: '{{ draft.quality_issues|escapejs }}',
                safety_incidents: '{{ draft.safety_incidents|escapejs }}',
                general_notes: '{{ draft.general_notes|escapejs }}',
                photos_taken: {{ draft.photos_taken|yesno:'true,false' }},
                milestone_id: {{ draft.milestone.id|default:'null' }}
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        };
        
        // Override sitedraft.js localStorage behavior - use database data instead
        window.sitedraftJsLoaded = true;
        
        // View toggle functionality
        document.querySelectorAll('.view-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const view = this.dataset.view;
                
                // Update active button
                document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                // Toggle views
                const cardView = document.getElementById('drafts-card-view');
                const tableView = document.getElementById('drafts-table-view');
                
                if (view === 'card') {
                    cardView.style.display = 'grid';
                    tableView.style.display = 'none';
                } else {
                    cardView.style.display = 'none';
                    tableView.style.display = 'block';
                }
            });
        });

        // Search functionality
        document.getElementById('search-input').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const cards = document.querySelectorAll('.draft-card');
            const rows = document.querySelectorAll('#drafts-table-body tr');
            
            // Filter cards
            cards.forEach(card => {
                const title = card.querySelector('.draft-title').textContent.toLowerCase();
                const excerpt = card.querySelector('.draft-excerpt').textContent.toLowerCase();
                card.style.display = (title.includes(searchTerm) || excerpt.includes(searchTerm)) ? 'block' : 'none';
            });
            
            // Filter table rows
            rows.forEach(row => {
                if (row.cells.length > 1) {
                    const project = row.cells[0].textContent.toLowerCase();
                    const excerpt = row.cells[2].textContent.toLowerCase();
                    row.style.display = (project.includes(searchTerm) || excerpt.includes(searchTerm)) ? '' : 'none';
                }
            });
        });

        // Category filter - disabled since we're using database data
        document.getElementById('category-filter').addEventListener('change', function() {
            const category = this.value;
            // Category filtering would need server-side implementation
            console.log('Category filter selected:', category);
        });

        // Delete draft function
        function deleteDraft(draftId) {
            if (confirm('Are you sure you want to delete this draft?')) {
                fetch(`{% url 'site_diary:delete_draft' 0 %}`.replace('0', draftId), {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Remove the draft card/row from DOM instead of full reload
                        const cardElement = document.querySelector(`[data-draft-id="${draftId}"]`);
                        if (cardElement) {
                            cardElement.remove();
                        }
                        // Update stats
                        updateDraftStats();
                        // Show success message
                        showNotification('Draft deleted successfully', 'success');
                    } else {
                        showNotification(data.message || 'Error deleting draft', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('Error deleting draft', 'error');
                });
            }
        }
        
        // Update draft statistics
        function updateDraftStats() {
            const remainingCards = document.querySelectorAll('.draft-card').length;
            document.getElementById('drafts-count').textContent = remainingCards;
            
            if (remainingCards === 0) {
                document.getElementById('drafts-card-view').innerHTML = `
                    <div class="no-drafts" id="no-drafts-message">
                        <i class="fas fa-file-alt"></i>
                        <h3>No Diary Drafts Found</h3>
                        <p>You haven't saved any diary entry drafts yet. Start creating a new diary entry to get started.</p>
                        <a href="{% url 'site_diary:diary' %}" class="btn btn-primary">Create New Diary Entry</a>
                    </div>
                `;
            }
        }
        
        // Show notification
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                ${message}
            `;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                background: ${type === 'success' ? '#28a745' : '#dc3545'};
                color: white;
                border-radius: 5px;
                z-index: 1000;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }
    </script>
{% endblock %}