{% extends 'admin-nav-footer-template/base.html' %}
{% load static %}
{% block title %}Admin Project Portfolio Management | Triple G BuildHub{% endblock %}
{% block extra_head %}

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Project Management | Triple G BuildHub</title>
    <link rel="stylesheet" href="{% static 'css/sitecss/reports.css' %}">
    <link rel="stylesheet" href="{% static 'css/sitecss/dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'css/admincss/adminclientproject.css' %}">
    <link rel="stylesheet" href="{% static 'css/admincss/nav.css' %}">
    <link rel="stylesheet" href="{% static 'css/admincss/header.css' %}">
    <link rel="stylesheet" href="{% static 'css/sitecss/global-modal.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal .modal-content { background: white; border-radius: 8px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .form-actions { display: flex; gap: 10px; justify-content: flex-end; }
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    {% endblock %}
    {% block content %}
 
    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <div class="page-title">
                <i class="fas fa-building"></i>
                <h1>Client Project Management</h1>
            </div>
            
            <div class="export-options">
                <button class="btn btn-primary" id="refreshBtn"><i class="fas fa-sync-alt"></i> Refresh</button>
                <button class="btn btn-primary"><i class="fas fa-file-pdf"></i> PDF</button>
                <button class="btn btn-primary"><i class="fas fa-file-csv"></i> CSV</button>
                <button class="btn btn-secondary"><i class="fas fa-print"></i> Print</button>
            </div>
        </div>
        
        <!-- Filter Section -->
        <div class="filter-container">
            <div class="filter-header">
                <div class="filter-title">
                    <i class="fas fa-filter"></i>
                    <span>Filter Projects</span>
                </div>
                
                <button class="filter-toggle" id="filterToggle">
                    <span>Hide Filters</span>
                    <i class="fas fa-chevron-up"></i>
                </button>
            </div>
            
            <div class="filter-content" id="filterOptions">
                <div class="filter-options">
                    <div class="filter-group">
                        <label for="filter-project">Project Name</label>
                        <input type="text" id="filter-project" placeholder="Project name">
                    </div>
                    
                    <div class="filter-group">
                        <label for="filter-architect">Architect</label>
                        <select id="filter-architect">
                            <option value="">All Architects</option>
                            <option value="John Smith">John Smith</option>
                            <option value="Sarah Johnson">Sarah Johnson</option>
                            <option value="Michael Brown">Michael Brown</option>
                            <option value="Emily Davis">Emily Davis</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="filter-type">Project Type</label>
                        <select id="filter-type">
                            <option value="">All Types</option>
                            <option value="Residential">Residential</option>
                            <option value="Commercial">Commercial</option>
                            <option value="Industrial">Industrial</option>
                            <option value="Infrastructure">Infrastructure</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="filter-status">Status</label>
                        <select id="filter-status">
                            <option value="">All Status</option>
                            <option value="Pending">Pending Review</option>
                            <option value="Approved">Approved</option>
                            <option value="Rejected">Rejected</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="filter-date-from">From Date</label>
                        <input type="date" id="filter-date-from" class="flatpickr">
                    </div>
                    
                    <div class="filter-group">
                        <label for="filter-date-to">To Date</label>
                        <input type="date" id="filter-date-to" class="flatpickr">
                    </div>
                </div>
                
                <div class="filter-buttons">
                    <button class="btn btn-secondary" id="resetFilters">
                        <i class="fas fa-undo"></i>
                        Reset Filters
                    </button>
                    <button class="btn btn-primary" id="applyFilters">
                        <i class="fas fa-search"></i>
                        Apply Filters
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Summary Section -->
        <div class="summary-section">
            <div class="summary-card">
                <i class="fas fa-clipboard-list summary-icon"></i>
                <div class="summary-title">Total Project Submissions</div>
                <div class="summary-value" id="totalProjects">{{ page_obj.paginator.count }}</div>
                <div class="summary-change">
                    <span>All submitted projects</span>
                </div>
            </div>
            
            <div class="summary-card warning">
                <i class="fas fa-exclamation-triangle summary-icon"></i>
                <div class="summary-title">Pending Review</div>
                <div class="summary-value" id="pendingProjects">{{ pending_projects.count }}</div>
                <div class="summary-change">
                    <span>Awaiting your approval</span>
                </div>
            </div>
            
            <div class="summary-card success">
                <i class="fas fa-check-circle summary-icon"></i>
                <div class="summary-title">Approved</div>
                <div class="summary-value" id="approvedProjects">{{ approved_count }}</div>
                <div class="summary-change">
                    <span>Visible to architects and clients</span>
                </div>
            </div>
            
            <div class="summary-card danger">
                <i class="fas fa-times-circle summary-icon"></i>
                <div class="summary-title">Rejected</div>
                <div class="summary-value" id="rejectedProjects">{{ rejected_count }}</div>
                <div class="summary-change">
                    <span>Requires architect revision</span>
                </div>
            </div>
        </div>
        
        <!-- Project List Section -->
        <div class="project-list-section">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-list"></i>
                    Submitted Client Projects
                </div>
            </div>
            
            <div class="table-container">
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Thumbnail</th>
                                <th>Project Name</th>
                                <th>Architect</th>
                                <th>Type</th>
                                <th>Budget (₱)</th>
                                <th>Dates</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for project in page_obj %}
                            <tr>
                                <td>
                                    {% if project.image %}
                                        <img src="{{ project.image.url }}" alt="{{ project.name }}" class="project-thumb">
                                    {% else %}
                                        <img src="{% static 'images/image6.jpg' %}" alt="{{ project.name }}" class="project-thumb">
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="project-title">{{ project.name }}</div>
                                    <div class="project-code">PRJ-{{ project.created_at.year }}-{{ project.id|stringformat:"03d" }}</div>
                                </td>
                                <td>{{ project.project_manager.get_full_name|default:project.project_manager.username }}</td>
                                <td>{{ project.description|truncatechars:20|default:"General" }}</td>
                                <td class="budget-cell">₱{{ project.budget|floatformat:0 }}</td>
                                <td>{{ project.start_date }} - {{ project.expected_end_date }}</td>
                                <td>
                                    <span class="status-badge status-{% if project.status == 'pending_approval' %}pending{% elif project.status == 'rejected' %}rejected{% else %}approved{% endif %}">
                                        {{ project.get_status_display }}
                                    </span>
                                </td>
                                <td>
                                    <div class="table-actions">
                                        <button class="action-btn view" title="View Project Details" data-id="{{ project.id }}">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        {% if project.status == 'pending_approval' %}
                                        <button class="action-btn approve" title="Approve Project" onclick="showApproveModal({{ project.id }}, '{{ project.name }}', '{{ project.project_manager.get_full_name }}')">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button class="action-btn reject" title="Reject Project" onclick="showRejectModal({{ project.id }}, '{{ project.name }}')">
                                            <i class="fas fa-times"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 2rem;">
                                    <i class="fas fa-inbox" style="font-size: 3rem; color: #ccc; margin-bottom: 1rem;"></i>
                                    <p>No projects found.</p>
                                </td>
                            </tr>
                            {% endfor %}

                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Pagination -->
            <div class="pagination">
                <button class="page-btn disabled">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="page-btn active">1</button>
                <button class="page-btn">2</button>
                <button class="page-btn">3</button>
                <span class="pagination-ellipsis">...</span>
                <button class="page-btn">10</button>
                <button class="page-btn">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Project Details Modal -->
    <div class="modal" id="projectDetailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>
                    <i class="fas fa-building"></i>
                    <span id="modalProjectTitle">Project Details</span>
                </h2>
                <button class="modal-close" id="closeDetailsModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="project-status-bar">
                    <span class="status-label">Current Status:</span>
                    <span class="status-badge status-pending" id="modalStatusBadge">Pending Review</span>
                    <span class="status-date" id="modalStatusDate">Submitted: Mar 15, 2025</span>
                </div>
                
                <div class="project-img-container">
                    <img src="{% static 'images/image6.jpg' %}" alt="Project Image" id="modalProjectImage">
                </div>
                
                <div class="project-details-grid">
                    <div class="detail-group">
                        <div class="detail-label">Project Code</div>
                        <div class="detail-value" id="modalProjectCode">PRJ-2025-001</div>
                    </div>
                    
                    <div class="detail-group">
                        <div class="detail-label">Architect</div>
                        <div class="detail-value" id="modalArchitect">John Smith</div>
                    </div>
                    
                    <div class="detail-group">
                        <div class="detail-label">Project Type</div>
                        <div class="detail-value" id="modalProjectType">Commercial</div>
                    </div>
                    
                    <div class="detail-group">
                        <div class="detail-label">Location</div>
                        <div class="detail-value" id="modalLocation">Downtown, Central Business District</div>
                    </div>
                    
                    <div class="detail-group">
                        <div class="detail-label">Start Date</div>
                        <div class="detail-value" id="modalStartDate">Apr 1, 2025</div>
                    </div>
                    
                    <div class="detail-group">
                        <div class="detail-label">Estimated End Date</div>
                        <div class="detail-value" id="modalEndDate">Dec 15, 2026</div>
                    </div>
                    
                    <div class="detail-group col-span-2">
                        <div class="detail-label">Project Budget</div>
                        <div class="detail-value budget" id="modalBudget">₱ 45,000,000.00</div>
                    </div>
                </div>
                
                <div class="project-description">
                    <div class="detail-label">Description</div>
                    <div class="detail-value" id="modalDescription">
                        Luxury commercial building with 35 floors, featuring premium office spaces and retail outlets. The design incorporates sustainable building practices including energy-efficient systems, green spaces, and rainwater harvesting. The foundation will utilize deep pile technology to support the high-rise structure. The facade will be primarily glass curtain wall with architectural concrete accents.
                    </div>
                </div>
                
                <div class="modal-actions" id="pendingActions">
                    <button class="btn btn-secondary" id="modalCloseBtn">Close</button>
                    <button class="btn btn-danger" id="modalRejectBtn">Reject Project</button>
                    <button class="btn btn-primary" id="modalApproveBtn">Approve Project</button>
                </div>
                
                <div class="modal-actions" id="approvedActions" style="display: none;">
                    <button class="btn btn-secondary" id="modalClose2Btn">Close</button>
                    <button class="btn btn-primary" id="modalDownloadBtn">
                        <i class="fas fa-download"></i> Download Details
                    </button>
                </div>
                
                <div class="modal-actions" id="rejectedActions" style="display: none;">
                    <button class="btn btn-secondary" id="modalClose3Btn">Close</button>
                    <button class="btn btn-warning" id="modalReconsiderBtn">
                        <i class="fas fa-redo"></i> Reconsider Project
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Approve Confirmation Modal -->
    <div class="modal" id="approveModal">
        <div class="modal-content confirmation-modal">
            <div class="modal-header">
                <h2>
                    <i class="fas fa-check-circle"></i>
                    Approve Project
                </h2>
                <button class="modal-close" id="closeApproveModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to approve this project? Once approved, it will be visible to architects and clients.</p>
                <div class="project-info">
                    <div class="project-info-item">
                        <strong>Project:</strong> <span id="approveProjectTitle">Harbor Tower</span>
                    </div>
                    <div class="project-info-item">
                        <strong>Submitted by:</strong> <span id="approveArchitect">John Smith</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="approveNotes">Admin Notes (Optional)</label>
                    <textarea id="approveNotes" rows="3" placeholder="Add any notes about this approval..."></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancelApproveBtn">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmApproveBtn">Approve Project</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Reject Confirmation Modal -->
    <div class="modal" id="rejectModal">
        <div class="modal-content confirmation-modal">
            <div class="modal-header">
                <h2>
                    <i class="fas fa-times-circle"></i>
                    Reject Project
                </h2>
                <button class="modal-close" id="closeRejectModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to reject this project? The architect will need to revise and resubmit it.</p>
                <div class="project-info">
                    <div class="project-info-item">
                        <strong>Project:</strong> <span id="rejectProjectTitle">Harbor Tower</span>
                    </div>
                    <div class="project-info-item">
                        <strong>Submitted by:</strong> <span id="rejectArchitect">John Smith</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="rejectReason">Reason for Rejection <span class="required">*</span></label>
                    <select id="rejectReason" required>
                        <option value="">Select Reason</option>
                        <option value="incomplete">Incomplete Information</option>
                        <option value="budget">Budget Issues</option>
                        <option value="scope">Scope Concerns</option>
                        <option value="technical">Technical Feasibility</option>
                        <option value="compliance">Compliance Issues</option>
                        <option value="other">Other (please specify)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="rejectNotes">Rejection Notes <span class="required">*</span></label>
                    <textarea id="rejectNotes" rows="3" placeholder="Provide detailed feedback for the architect..." required></textarea>
                </div>
                
                <form method="post" id="rejectForm">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="reject">
                    <input type="hidden" name="project_id" id="rejectProjectId">
                    <input type="hidden" name="rejection_reason" id="rejectReasonInput">
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancelRejectBtn">Cancel</button>
                        <button type="submit" class="btn btn-danger" id="confirmRejectBtn">Reject Project</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
  
    {% endblock %}
    {% block extra_scripts %}
    <script src="{% static 'js/sitejs/global-modal.js' %}"></script>
    <script src="{% static 'js/adminjs/mobile-btn.js' %}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.budget-cell').forEach(cell => {
                const text = cell.textContent;
                const num = parseFloat(text.replace(/[^\d.]/g, ''));
                if (!isNaN(num)) {
                    cell.textContent = '₱' + num.toLocaleString('en-PH', {minimumFractionDigits: 0, maximumFractionDigits: 0});
                }
            });
            
            let currentProjectId = null;
            document.querySelectorAll('.action-btn.view').forEach(btn => {
                btn.addEventListener('click', function() {
                    currentProjectId = this.dataset.id;
                    const row = this.closest('tr');
                    const name = row.querySelector('.project-title').textContent;
                    const code = row.querySelector('.project-code').textContent;
                    const architect = row.cells[2].textContent;
                    const type = row.cells[3].textContent;
                    const budget = row.cells[4].textContent;
                    const dates = row.cells[5].textContent;
                    const status = row.querySelector('.status-badge').textContent;
                    const img = row.querySelector('.project-thumb').src;
                    
                    document.getElementById('modalProjectTitle').textContent = name;
                    document.getElementById('modalProjectCode').textContent = code;
                    document.getElementById('modalArchitect').textContent = architect;
                    document.getElementById('modalProjectType').textContent = type;
                    const budgetNum = parseFloat(budget.replace(/[^\d.]/g, ''));
                    document.getElementById('modalBudget').textContent = '₱ ' + budgetNum.toLocaleString('en-PH', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                    document.getElementById('modalProjectImage').src = img;
                    document.getElementById('modalStatusBadge').textContent = status;
                    document.getElementById('projectDetailsModal').classList.add('active');
                });
            });
            
            document.getElementById('closeDetailsModal').addEventListener('click', () => {
                document.getElementById('projectDetailsModal').classList.remove('active');
            });
            document.getElementById('modalCloseBtn').addEventListener('click', () => {
                document.getElementById('projectDetailsModal').classList.remove('active');
            });
            
            document.getElementById('modalRejectBtn').addEventListener('click', () => {
                const projectName = document.getElementById('modalProjectTitle').textContent;
                document.getElementById('projectDetailsModal').classList.remove('active');
                showRejectModal(currentProjectId, projectName);
            });
            
            document.getElementById('modalApproveBtn').addEventListener('click', () => {
                const projectName = document.getElementById('modalProjectTitle').textContent;
                const architect = document.getElementById('modalArchitect').textContent;
                document.getElementById('projectDetailsModal').classList.remove('active');
                showApproveModal(currentProjectId, projectName, architect);
            });
        });
        
        function showApproveModal(projectId, projectName, architectName) {
            globalModal.show({
                type: 'success',
                icon: 'fa-check-circle',
                title: 'Approve Project',
                message: `Are you sure you want to approve "${projectName}"? Once approved, it will be visible to architects and clients.`,
                confirmText: 'Approve',
                cancelText: 'Cancel',
                showCancel: true,
                confirmClass: 'global-modal-btn-success',
                onConfirm: () => {
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.innerHTML = `
                        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                        <input type="hidden" name="action" value="approve">
                        <input type="hidden" name="project_id" value="${projectId}">
                    `;
                    document.body.appendChild(form);
                    form.submit();
                }
            });
        }
        
        function showRejectModal(projectId, projectName) {
            document.getElementById('rejectProjectTitle').textContent = projectName;
            document.getElementById('rejectProjectId').value = projectId;
            document.getElementById('rejectReason').value = '';
            document.getElementById('rejectNotes').value = '';
            document.getElementById('rejectModal').classList.add('active');
        }
        
        document.getElementById('closeRejectModal').addEventListener('click', () => {
            document.getElementById('rejectModal').classList.remove('active');
        });
        document.getElementById('cancelRejectBtn').addEventListener('click', () => {
            document.getElementById('rejectModal').classList.remove('active');
        });
        
        document.getElementById('rejectForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const reason = document.getElementById('rejectReason').value;
            const notes = document.getElementById('rejectNotes').value.trim();
            if (!reason || !notes) {
                alert('Please select a reason and provide rejection notes.');
                return;
            }
            
            const btn = document.getElementById('confirmRejectBtn');
            const icon = btn.querySelector('i');
            if (icon) icon.className = 'fas fa-spinner fa-spin';
            btn.disabled = true;
            btn.textContent = ' Rejecting...';
            if (icon) btn.prepend(icon);
            
            document.getElementById('rejectReasonInput').value = `${reason}: ${notes}`;
            e.target.submit();
        });
    </script>
    {% endblock %}
</body>
</html>
