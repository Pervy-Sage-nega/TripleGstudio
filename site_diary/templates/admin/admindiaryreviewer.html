{% extends 'admin-nav-footer-template/base.html' %}
{% load static %}
{% block title %}Admin Project Portfolio Management | Triple G BuildHub{% endblock %}
{% block extra_head %}

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Site Diary Review | Triple G BuildHub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="{% static 'css/sitecss/diary.css' %}">
    <link rel="stylesheet" href="{% static 'css/sitecss/dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'css/sitecss/history.css' %}">
    <link rel="stylesheet" href="{% static 'css/admincss/nav.css' %}">
    <link rel="stylesheet" href="{% static 'css/admincss/header.css' %}">
    <link rel="stylesheet" href="{% static 'css/admincss/admindiaryreviewer.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    {% endblock %}
    {% block content %}
    <!-- DEBUG: Django template is rendering. Total entries: {{ total_count }} -->
    <!-- Main Content Container -->
    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <div class="page-title">
                <i class="fas fa-clipboard-check"></i>
                <h1>Site Diary Review</h1>
            </div>
            
            <div class="export-options">
                <button class="btn btn-primary" id="refreshBtn"><i class="fas fa-sync-alt"></i> Refresh</button>
                                <button class="btn btn-primary" id="exportPdfBtn">                    <i class="fas fa-file-pdf"></i> PDF                </button>                <button class="btn btn-primary" id="exportCsvBtn">                    <i class="fas fa-file-csv"></i> CSV                </button>
                <button class="btn btn-secondary" id="printBtn">
                    <i class="fas fa-print"></i> Print
                </button>
            </div>
        </div>
        
        <!-- Status Tracker Section -->
        <div class="summary-section">
            <div class="summary-card">
                <i class="fas fa-hourglass-half summary-icon"></i>
                <div class="summary-title">Pending Review</div>
                <div class="summary-value" id="totalPending">{{ pending_count }}</div>
                <div class="summary-change">
                    <span>Awaiting approval</span>
                </div>
            </div>
            <div class="summary-card success">
                <i class="fas fa-check-circle summary-icon"></i>
                <div class="summary-title">Approved</div>
                <div class="summary-value" id="totalApproved">{{ approved_count }}</div>
                <div class="summary-change">
                    <span>Diary entries</span>
                </div>
            </div>
            <div class="summary-card warning">
                <i class="fas fa-history summary-icon"></i>
                <div class="summary-title">Needs Revision</div>
                <div class="summary-value" id="totalRevision">{{ revision_count }}</div>
                <div class="summary-change">
                    <span>Sent back to architects</span>
                </div>
            </div>
            <div class="summary-card info">
                <i class="fas fa-clipboard-list summary-icon"></i>
                <div class="summary-title">Total Entries</div>
                <div class="summary-value" id="totalEntries">{{ total_count }}</div>
                <div class="summary-change">
                    <span>All submitted entries</span>
                </div>
            </div>
        </div>
        
        <!-- Filter and Search Section -->
        <div class="filter-container">
            <div class="filter-header">
                <div class="filter-title">
                    <i class="fas fa-filter"></i>
                    <span>Filter Entries</span>
                </div>
                
                <button class="filter-toggle" id="filterToggle">
                    <span>Hide Filters</span>
                    <i class="fas fa-chevron-up"></i>
                </button>
            </div>
            
            <div class="filter-content" id="filterOptions">
                <div class="filter-options">
                    <div class="filter-group">
                        <label for="filter-architect">Architect/Site Manager</label>
                        <select id="filter-architect">
                            <option value="">All Architects</option>
                            {% for user in architects %}
                            <option value="{{ user.username }}" {% if request.GET.architect == user.username %}selected{% endif %}>{{ user.get_full_name|default:user.username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="filter-project">Project</label>
                        <select id="filter-project">
                            <option value="">All Projects</option>
                            {% for project in projects %}
                            <option value="{{ project.name }}" {% if request.GET.project == project.name %}selected{% endif %}>{{ project.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="filter-status">Status</label>
                        <select id="filter-status">
                            <option value="">All Status</option>
                            <option value="pending" {% if request.GET.status == 'pending' %}selected{% endif %}>Pending Review</option>
                            <option value="approved" {% if request.GET.status == 'approved' %}selected{% endif %}>Approved</option>
                            <option value="revision" {% if request.GET.status == 'revision' %}selected{% endif %}>Needs Revision</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="filter-date-from">Date From</label>
                        <input type="date" id="filter-date-from" class="flatpickr" value="{{ request.GET.date_from }}">
                    </div>
                    
                    <div class="filter-group">
                        <label for="filter-date-to">Date To</label>
                        <input type="date" id="filter-date-to" class="flatpickr" value="{{ request.GET.date_to }}">
                    </div>
                    
                    <div class="filter-group" style="grid-column: span 2;">
                        <label for="search">Search</label>
                        <input type="text" id="search" class="search-input" placeholder="Search by project name, architect, location..." value="{{ request.GET.search }}">
                    </div>
                </div>
                
                <div class="filter-buttons">
                    <button class="btn btn-secondary" id="resetFilters">
                        <i class="fas fa-undo"></i>
                        Reset Filters
                    </button>
                    <button class="btn btn-primary" id="applyFilters">
                        <i class="fas fa-search"></i>
                        Apply Filters
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Reports Section with View Toggle -->
        <div class="reports-section">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-list"></i>
                    Submitted Diary Entries
                </div>
                <div class="view-toggle">
                    <button id="historyModeBtn" class="view-btn" title="History Mode">
                        <i class="fas fa-history"></i> History Mode
                    </button>
                    <button id="timelineViewBtn" class="view-btn active" title="Timeline View">
                        <i class="fas fa-stream" style="color: #2a5254;"></i> Timeline View
                    </button>
                    <button id="tableViewBtn" class="view-btn" title="Table View">
                        <i class="fas fa-table"></i> Table View
                    </button>
                    <button id="expandAllBtn" class="view-btn" title="Expand All">
                        <i class="fas fa-expand-alt"></i> Expand All
                    </button>
                    <button id="collapseAllBtn" class="view-btn" title="Collapse All">
                        <i class="fas fa-compress-alt"></i> Collapse All
                    </button>
                </div>
            </div>
            
            <div class="content-container">
                <!-- Timeline View -->
                <div class="timeline-container" id="timelineView">
                    <div class="timeline">
                        {% regroup page_obj by entry_date as entries_by_date %}
                        {% for date_group in entries_by_date %}
                        <!-- Timeline Date Header -->
                        <div class="timeline-date-header">
                            <h3><i class="fas fa-calendar-day"></i> {{ date_group.grouper|date:"F d, Y" }}</h3>
                        </div>
                        
                        {% for entry in date_group.list %}
                        <!-- Timeline Entry -->
                        <div class="timeline-item {% if entry.approved %}status-approved{% else %}status-pending{% endif %}">
                            <div class="timeline-header" data-id="{{ entry.id }}">
                                <div class="timeline-date">
                                    <div class="timeline-time">{{ entry.created_at|date:"g:i A" }}</div>
                                    <div class="timeline-status">
                                        {% if entry.approved %}
                                        <span class="status-badge status-approved-badge">Approved</span>
                                        {% else %}
                                        <span class="status-badge status-pending-badge">Pending Review</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <h3>{{ entry.project.name }}</h3>
                                <div class="timeline-meta">
                                    <span class="entry-id">SDR-{{ entry.id|stringformat:"04d" }}</span>
                                    <div class="action-btn expand">
                                        <i class="fas fa-chevron-down"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="timeline-content" id="content{{ entry.id }}">
                                <div class="content-grid">
                                    <div class="info-section">
                                        <div class="info-item">
                                            <div class="info-label">Site Manager:</div>
                                            <div class="info-value">{{ entry.created_by.get_full_name|default:entry.created_by.username }}</div>
                                        </div>
                                        <div class="info-item">
                                            <div class="info-label">Location:</div>
                                            <div class="info-value">{{ entry.project.location }}</div>
                                        </div>
                                        <div class="info-item">
                                            <div class="info-label">Milestone:</div>
                                            <div class="info-value">{{ entry.milestone.name|default:"Not specified" }}</div>
                                        </div>
                                        <div class="info-item">
                                            <div class="info-label">Progress:</div>
                                            <div class="info-value">{{ entry.progress_percentage }}%</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="timeline-description">
                                    <h4>Work Description</h4>
                                    <p>{{ entry.work_description|default:"No description provided" }}</p>
                                    {% if entry.quality_issues %}
                                    <h4>Quality Issues</h4>
                                    <p>{{ entry.quality_issues }}</p>
                                    {% endif %}
                                    {% if entry.safety_incidents %}
                                    <h4>Safety Incidents</h4>
                                    <p>{{ entry.safety_incidents }}</p>
                                    {% endif %}
                                </div>
                                <div class="timeline-actions">
                                    {% if not entry.approved %}
                                    <form method="post" style="display: inline;">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="approve">
                                        <input type="hidden" name="entry_id" value="{{ entry.id }}">
                                        <button type="submit" class="btn btn-success">
                                            <i class="fas fa-check"></i> Approve
                                        </button>
                                    </form>
                                    {% endif %}
                                    <button class="btn btn-primary view-entry-btn" data-entry-id="{{ entry.id }}">
                                        <i class="fas fa-eye"></i> View Details
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        {% empty %}
                        <div class="no-entries">
                            <p><strong>DEBUG:</strong> No diary entries found in database. Total entries: {{ total_count }}</p>
                            <p>If you see static data above, it means the template is not being rendered by Django.</p>
                        </div>
                        {% endfor %}

                    </div>
                </div>
                
                <!-- Table View -->
                <div class="table-container" id="tableView" style="display: none;">
                    <div class="table-responsive">
                        <table class="entries-table">
                            <thead>
                                <tr>
                                    <th>
                                        <div class="th-content">
                                            <span>Entry ID</span>
                                            <i class="fas fa-sort"></i>
                                        </div>
                                    </th>
                                    <th>
                                        <div class="th-content">
                                            <span>Date</span>
                                            <i class="fas fa-sort"></i>
                                        </div>
                                    </th>
                                    <th>
                                        <div class="th-content">
                                            <span>Project</span>
                                            <i class="fas fa-sort"></i>
                                        </div>
                                    </th>
                                    <th>
                                        <div class="th-content">
                                            <span>Architect</span>
                                            <i class="fas fa-sort"></i>
                                        </div>
                                    </th>
                                    <th>
                                        <div class="th-content">
                                            <span>Milestone</span>
                                            <i class="fas fa-sort"></i>
                                        </div>
                                    </th>
                                    <th>
                                        <div class="th-content">
                                            <span>Status</span>
                                            <i class="fas fa-sort"></i>
                                        </div>
                                    </th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entry in page_obj %}
                                <tr data-status="{% if entry.approved %}approved{% else %}pending{% endif %}">
                                    <td>SDR-{{ entry.id|stringformat:"04d" }}</td>
                                    <td>{{ entry.entry_date|date:"M d, Y" }}</td>
                                    <td>{{ entry.project.name }}</td>
                                    <td>{{ entry.created_by.get_full_name|default:entry.created_by.username }}</td>
                                    <td>{{ entry.milestone.name|default:"Not specified" }}</td>
                                    <td>
                                        {% if entry.approved %}
                                        <span class="status-badge status-approved-badge">Approved</span>
                                        {% else %}
                                        <span class="status-badge status-pending-badge">Pending</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="table-actions">
                                            {% if not entry.approved %}
                                            <form method="post" style="display: inline;">
                                                {% csrf_token %}
                                                <input type="hidden" name="action" value="approve">
                                                <input type="hidden" name="entry_id" value="{{ entry.id }}">
                                                <button type="submit" class="action-btn approve" title="Approve Entry">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                            </form>
                                            {% endif %}
                                            <button class="action-btn view" title="View Entry" data-entry-id="{{ entry.id }}">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center">No diary entries found.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    {% if page_obj.has_other_pages %}
                    <div class="pagination">
                        {% if page_obj.has_previous %}
                        <button class="page-btn" onclick="navigateToPage({{ page_obj.previous_page_number }})">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        {% else %}
                        <button class="page-btn disabled">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        {% endif %}
                        
                        {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                            <button class="page-btn active">{{ num }}</button>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <button class="page-btn" onclick="navigateToPage({{ num }})">{{ num }}</button>
                            {% endif %}
                        {% endfor %}
                        
                        {% if page_obj.has_next %}
                        <button class="page-btn" onclick="navigateToPage({{ page_obj.next_page_number }})">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                        {% else %}
                        <button class="page-btn disabled">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    

    {% endblock %}
    {% block extra_scripts %}
    <script src="{% static 'js/adminjs/mobile-btn.js' %}"></script>
    <script src="{% static 'js/adminjs/admindiaryreviewer.js' %}"></script>
    {% endblock %}

</body>
</html>