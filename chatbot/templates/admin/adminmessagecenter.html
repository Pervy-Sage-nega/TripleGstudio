{% extends 'admin-nav-footer-template/base.html' %}
{% load static %}
{% block title %}Admin Message Center | Triple G BuildHub{% endblock %}
{% block extra_head %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="user-role" content="admin">
    <link rel="stylesheet" href="{% static 'css/sitecss/dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'css/sitecss/history.css' %}">
    <link rel="stylesheet" href="{% static 'css/sitecss/chatbot.css' %}">
    <link rel="stylesheet" href="{% static 'css/admincss/adminmessagecenter.css' %}">
    <link rel="stylesheet" href="{% static 'css/admincss/header.css' %}">
    <link rel="stylesheet" href="{% static 'css/admincss/nav.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block content %}
<body>
    <div class="container">
        <div class="page-header">
            <div class="page-title">
                <i class="fas fa-comments"></i>
                <h1>Admin Message Center</h1>
                <span class="notification-badge">{{ new_count }}</span>
            </div>
            <div class="export-options">
                <button class="btn btn-primary" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <button class="btn btn-primary" id="exportPdfBtn">
                    <i class="fas fa-file-pdf"></i> PDF
                </button>
                <button class="btn btn-primary" id="exportCsvBtn">
                    <i class="fas fa-file-csv"></i> CSV
                </button>
                <button class="btn btn-secondary" id="printBtn">
                    <i class="fas fa-print"></i> Print
                </button>
            </div>
        </div>

        <!-- Status Tracker Section -->
        <div class="status-tracker">
            <div class="status-card">
                <div class="status-icon status-new-icon">
                    <i class="fas fa-envelope"></i>
                </div>
                <div class="status-info">
                    <h3>{{ new_count }}</h3>
                    <p>New Messages</p>
                </div>
            </div>
            <div class="status-card">
                <div class="status-icon status-read-icon">
                    <i class="fas fa-envelope-open"></i>
                </div>
                <div class="status-info">
                    <h3>{{ read_count }}</h3>
                    <p>Read Messages</p>
                </div>
            </div>
            <div class="status-card">
                <div class="status-icon status-reviewed-icon">
                    <i class="fas fa-clipboard-check"></i>
                </div>
                <div class="status-info">
                    <h3>{{ reviewed_count }}</h3>
                    <p>Reviewed</p>
                </div>
            </div>
            <div class="status-card">
                <div class="status-icon status-archived-icon">
                    <i class="fas fa-archive"></i>
                </div>
                <div class="status-info">
                    <h3>{{ archived_count }}</h3>
                    <p>Archived</p>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="view-controls">
            <div class="tabs">
                <button class="tab-btn active" data-tab="all">All Messages</button>
                <button class="tab-btn" data-tab="new">New</button>
                <button class="tab-btn" data-tab="read">Read</button>
                <button class="tab-btn" data-tab="reviewed">Reviewed</button>
                <button class="tab-btn" data-tab="archived">Archived</button>
            </div>

            <div class="view-toggle">
                <button id="timelineViewBtn" class="view-btn active" title="Timeline View">
                    <i class="fas fa-stream"></i>
                </button>
                <button id="tableViewBtn" class="view-btn" title="Table View">
                    <i class="fas fa-table"></i>
                </button>
            </div>
        </div>

        <!-- Filter and Search Section -->
        <div class="filter-container">
            <div class="filter-header">
                <div class="filter-title">
                    <i class="fas fa-filter"></i>
                    <span>Filter Messages</span>
                </div>
                <button class="filter-toggle" id="filterToggle">
                    <span>Show Filters</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
            </div>

            <div class="search-box">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" placeholder="Search by name, email, or phone...">
            </div>

            <div class="filter-options" id="filterOptions" style="display: none;">
                <div class="filter-group">
                    <label for="filter-name">Name</label>
                    <input type="text" id="filter-name" placeholder="Enter name...">
                </div>
                <div class="filter-group">
                    <label for="filter-email">Email</label>
                    <input type="text" id="filter-email" placeholder="Enter email...">
                </div>
                <div class="filter-group">
                    <label for="filter-phone">Phone Number</label>
                    <input type="text" id="filter-phone" placeholder="Enter phone number...">
                </div>
                <div class="filter-buttons">
                    <button class="btn btn-secondary" id="resetFilters">
                        <i class="fas fa-undo"></i> Reset
                    </button>
                    <button class="btn btn-primary" id="applyFilters">
                        <i class="fas fa-check"></i> Apply Filters
                    </button>
                </div>
            </div>
        </div>

        <!-- Timeline View -->
        <div class="timeline-view" id="timelineView">
            <div class="timeline-line"></div>
            {% for message in chatbot_messages %}
            <div class="timeline-item" data-status="{{ message.status }}">
                <div class="timeline-header" data-id="{{ message.id }}">
                    <div class="timeline-date">
                        <i class="fas fa-user-circle"></i>
                        <div>
                            <h3>{{ message.name }}</h3>
                            <span>{{ message.created_at|date:"M d, Y • g:i A" }}</span>
                            <span class="log-status status-{{ message.status }}">{{ message.get_status_display }}</span>
                        </div>
                    </div>
                    <div class="timeline-actions">
                        {% if message.status == 'new' %}
                        <button class="action-btn mark-read" data-message-id="{{ message.id }}" title="Mark as Read">
                            <i class="fas fa-eye"></i>
                        </button>
                        {% elif message.status == 'read' %}
                        <button class="action-btn mark-reviewed" data-message-id="{{ message.id }}" title="Mark as Reviewed">
                            <i class="fas fa-clipboard-check"></i>
                        </button>
                        <button class="action-btn mark-unread" data-message-id="{{ message.id }}" title="Mark as Unread">
                            <i class="fas fa-undo"></i>
                        </button>
                        {% elif message.status == 'reviewed' %}
                        <button class="action-btn archive" data-message-id="{{ message.id }}" title="Archive">
                            <i class="fas fa-archive"></i>
                        </button>
                        <button class="action-btn mark-unread" data-message-id="{{ message.id }}" title="Mark as Unread">
                            <i class="fas fa-undo"></i>
                        </button>
                        {% else %}
                        <button class="action-btn unarchive" data-message-id="{{ message.id }}" title="Unarchive">
                            <i class="fas fa-box-open"></i>
                        </button>
                        {% endif %}
                        <button class="action-btn delete" data-message-id="{{ message.id }}" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="action-btn expand" title="Expand/Collapse">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </div>
                </div>

                <div class="timeline-content" id="content{{ message.id }}">
                    <div class="timeline-client-info">
                        <div class="info-group">
                            <div class="info-label">Email</div>
                            <div class="info-value">{{ message.email }}</div>
                        </div>
                        {% if message.phone %}
                        <div class="info-group">
                            <div class="info-label">Phone</div>
                            <div class="info-value">{{ message.phone }}</div>
                        </div>
                        {% endif %}
                    </div>

                    <div class="activities-section">
                        <div class="section-title">
                            <i class="fas fa-comment-alt"></i>
                            <span>Message</span>
                        </div>
                        <div class="message-content">
                            {{ message.message|linebreaks }}
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="timeline-item">
                <div class="timeline-content">
                    <p style="text-align: center; color: #ccc; padding: 40px;">No messages found.</p>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Table View -->
        <div class="table-view" id="tableView" style="display: none;">
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Date & Time</th>
                            <th>Client</th>
                            <th>Phone</th>
                            <th>Message</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for message in chatbot_messages %}
                        <tr data-status="{{ message.status }}">
                            <td>{{ message.created_at|date:"M d, Y • g:i A" }}</td>
                            <td>
                                <div class="client-name">{{ message.name }}</div>
                                <div class="client-email">{{ message.email }}</div>
                                <span class="log-status status-{{ message.status }}">{{ message.get_status_display }}</span>
                            </td>
                            <td>{{ message.phone|default:"-" }}</td>
                            <td>{{ message.message|truncatechars:50 }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" style="text-align: center; color: #ccc; padding: 40px;">No messages found.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_scripts %}
    <script src="{% static 'js/adminjs/mobile-btn.js' %}"></script>
    <script src="{% static 'js/adminjs/adminmessagecenter.js' %}"></script>
{% endblock %}
</body>