{% extends "site_diary/layout_format.html" %}
{% load static %}

{% block head %}
    <title>Project Details - {{ project.name|default:"Harbor Tower" }} | Triple G BuildHub</title>
    <link rel="stylesheet" href="{% static 'css/sitecss/global-footer.css' %}">
    <link rel="stylesheet" href="{% static 'css/sitecss/siteproject-detail.css' %}">
       <link rel="stylesheet" href="{% static 'css/sitecss/dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'css/sitecss/createblog.css' %}">
    <link rel="stylesheet" href="{% static 'css/sitecss/header-container.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block body %}
    <div class="container">
         <div class="dashboard-header">
            <div class="dashboard-title">
                <i class="fas fa-tachometer-alt"></i>
                <h1>Project Dashboard</h1>
            </div>
            <div class="user-info">
                <div class="user-greeting">
                    <div class="user-name">{{ user.get_full_name|default:user.email }}</div>
                    <div class="user-role">{% if user.is_staff %}Site Manager{% else %}Project Member{% endif %}</div>
                </div>
                <div class="user-avatar">{{ user.first_name.0|default:user.email.0|upper }}{{ user.last_name.0|default:'' }}</div>
            </div>
        </div>
   
        <!-- Project Header Section -->
        <div class="project-header-section">
            <!-- Project Summary Header -->
            <div class="project-header">
                <div class="project-image">
                    {% if project.image %}
                        <img src="{{ project.image.url }}" alt="{{ project.name }}">
                    {% else %}
                        <img src="{% static 'images/image6.jpg' %}" alt="{{ project.name }}">
                    {% endif %}
                </div>
                <div class="project-info">
                    <div class="project-title-section">
                        <h1 class="project-title">{{ project.name|default:"Harbor Tower" }}</h1>
                        <span class="project-code">{{ project.code|default:"HT-2024-001" }}</span>
                        <span class="status-badge status-{{ project.status|default:'active' }}">
                            {{ project.get_status_display|default:"Active" }}
                        </span>
                    </div>
                    <div class="client-info">
                        <div class="info-item">
                            <i class="fas fa-user"></i>
                            <span>{{ project.client_name }}</span>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-hard-hat"></i>
                            <span>Site Manager: {{ project.project_manager.get_full_name|default:project.project_manager.username }}</span>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>{{ project.location }}</span>
                        </div>
                    </div>
                </div>
                <div class="project-dates">
                    <div class="date-item">
                        <span class="date-label">Start Date</span>
                        <span class="date-value">{{ project.start_date|date:"M d, Y" }}</span>
                    </div>
                    <div class="date-item">
                        <span class="date-label">Target Completion</span>
                        <span class="date-value">{{ project.expected_end_date|date:"M d, Y" }}</span>
                    </div>
                    <div class="date-item">
                        <span class="date-label">Current Phase</span>
                        <span class="date-value">{{ phase_name }}</span>
                    </div>
                </div>
            </div>

            <!-- Progress Overview Sidebar -->
            <div class="progress-overview-sidebar">
                <h3 class="sidebar-title">
                    <i class="fas fa-chart-line"></i> Progress Overview
                </h3>
                <div class="progress-content">
                    <div class="circular-progress">
                        <div class="progress-circle" data-progress="{{ progress }}">
                            <span class="progress-text">{{ progress|floatformat:0 }}%</span>
                        </div>
                    </div>
                    <div class="milestone-progress">
                        <div class="milestone-item completed">
                            <span class="milestone-name">Planning</span>
                            <div class="milestone-bar">
                                <div class="milestone-fill" style="width: 100%"></div>
                            </div>
                        </div>
                        <div class="milestone-item completed">
                            <span class="milestone-name">Foundation</span>
                            <div class="milestone-bar">
                                <div class="milestone-fill" style="width: 100%"></div>
                            </div>
                        </div>
                        <div class="milestone-item active">
                            <span class="milestone-name">Structure</span>
                            <div class="milestone-bar">
                                <div class="milestone-fill" style="width: 70%"></div>
                            </div>
                        </div>
                        <div class="milestone-item">
                            <span class="milestone-name">Finishing</span>
                            <div class="milestone-bar">
                                <div class="milestone-fill" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <button class="btn btn-outline" onclick="openTimelineModal()">
                    <i class="fas fa-timeline"></i> View Timeline
                </button>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="detail-grid">

            <!-- Budget Tracking -->
            <div class="detail-card budget-card">
                <h3 class="card-title">
                    <i class="fas fa-dollar-sign"></i> Budget Tracking
                </h3>
                <div class="budget-summary">
                    <div class="budget-item">
                        <span class="budget-label">Total Budget</span>
                        <span class="budget-value total">₱{{ total_budget|floatformat:2 }}</span>
                    </div>
                    <div class="budget-item">
                        <span class="budget-label">Total Spent</span>
                        <span class="budget-value spent">₱{{ total_spent|floatformat:2 }}</span>
                    </div>
                    <div class="budget-item">
                        <span class="budget-label">Remaining</span>
                        <span class="budget-value remaining">₱{{ remaining_budget|floatformat:2 }}</span>
                    </div>
                </div>
                <div class="budget-chart">
                    <div class="chart-container">
                        <canvas id="budgetChart" width="200" height="200"></canvas>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="generateFinancialReport()">
                    <i class="fas fa-file-invoice-dollar"></i> Generate Report
                </button>
            </div>

            <!-- Site Diary Summary -->
            <div class="detail-card diary-card">
                <h3 class="card-title">
                    <i class="fas fa-book"></i> Recent Site Diary Entries
                </h3>
                <div class="diary-entries">
                    {% for entry in recent_diary_entries %}
                    <div class="diary-entry">
                        <div class="entry-date">{{ entry.entry_date|date:"M d, Y" }}</div>
                        <div class="entry-summary">{{ entry.work_description|truncatechars:80 }}</div>
                        <div class="entry-progress">Progress: {{ entry.progress_percentage|floatformat:0 }}%</div>
                    </div>
                    {% empty %}
                    <div class="diary-entry">
                        <div class="entry-summary">No diary entries found for this project.</div>
                    </div>
                    {% endfor %}
                </div>
                <a href="{% url 'site_diary:diary' %}" class="btn btn-outline">
                    <i class="fas fa-external-link-alt"></i> View Full Diary Log
                </a>
            </div>

            <!-- Labor & Equipment -->
            <div class="detail-card resources-card">
                <h3 class="card-title">
                    <i class="fas fa-hard-hat"></i> Labor & Equipment
                </h3>
                <div class="resource-stats">
                    <div class="stat-item">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info">
                            <span class="stat-number">{{ labor_count }}</span>
                            <span class="stat-label">Total Workers</span>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon">
                            <i class="fas fa-tools"></i>
                        </div>
                        <div class="stat-info">
                            <span class="stat-number">{{ equipment_count }}</span>
                            <span class="stat-label">Equipment Units</span>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="stat-info">
                            <span class="stat-number">{{ delays_count }}</span>
                            <span class="stat-label">Logged Delays</span>
                        </div>
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="addResourceEntry()" disabled>
                    <i class="fas fa-plus"></i> Add Entry
                </button>
            </div>

            <!-- Reports & Files -->
            <div class="detail-card files-card">
                <h3 class="card-title">
                    <i class="fas fa-folder-open"></i> Reports & Documents
                </h3>
                <div class="files-list">
                    <div class="file-item">
                        <div class="file-info">
                            <i class="fas fa-file-pdf"></i>
                            <span class="file-name">Weekly Progress Report - Week 48</span>
                        </div>
                        <div class="file-meta">
                            <span class="file-date">Dec 12, 2024</span>
                            <div class="file-actions">
                                <button class="btn-icon" title="Download">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="btn-icon" title="Preview">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="file-item">
                        <div class="file-info">
                            <i class="fas fa-file-excel"></i>
                            <span class="file-name">Budget Analysis Q4 2024</span>
                        </div>
                        <div class="file-meta">
                            <span class="file-date">Dec 10, 2024</span>
                            <div class="file-actions">
                                <button class="btn-icon" title="Download">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="btn-icon" title="Preview">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="file-item">
                        <div class="file-info">
                            <i class="fas fa-file-image"></i>
                            <span class="file-name">Site Photos - Foundation Complete</span>
                        </div>
                        <div class="file-meta">
                            <span class="file-date">Dec 8, 2024</span>
                            <div class="file-actions">
                                <button class="btn-icon" title="Download">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="btn-icon" title="Preview">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <button class="btn btn-outline">
                    <i class="fas fa-upload"></i> Upload Document
                </button>
            </div>
        </div>
    </div>

    <!-- Timeline Modal -->
    <div id="timelineModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Project Timeline</h3>
                <span class="modal-close" onclick="closeTimelineModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="timeline">
                    <div class="timeline-item completed">
                        <div class="timeline-dot"></div>
                        <div class="timeline-content">
                            <h4>Project Planning</h4>
                            <span class="timeline-date">Jan 15 - Feb 28, 2024</span>
                            <p>Initial planning, permits, and design finalization completed.</p>
                        </div>
                    </div>
                    <div class="timeline-item completed">
                        <div class="timeline-dot"></div>
                        <div class="timeline-content">
                            <h4>Foundation Work</h4>
                            <span class="timeline-date">Mar 1 - May 15, 2024</span>
                            <p>Excavation, foundation laying, and structural groundwork completed.</p>
                        </div>
                    </div>
                    <div class="timeline-item active">
                        <div class="timeline-dot"></div>
                        <div class="timeline-content">
                            <h4>Structural Construction</h4>
                            <span class="timeline-date">May 16 - Sep 30, 2024</span>
                            <p>Main structure, steel framework, and concrete work in progress.</p>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-dot"></div>
                        <div class="timeline-content">
                            <h4>Finishing Work</h4>
                            <span class="timeline-date">Oct 1 - Dec 20, 2024</span>
                            <p>Interior finishing, utilities installation, and final inspections.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="{% static 'js/sitejs/project-detail.js' %}"></script>
    {% include "site_diary/navtemplate/layoutfooter.html" %}
{% endblock %}